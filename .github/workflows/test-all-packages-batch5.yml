name: Test All Packages (Batch 5) on Arm64

on:
  schedule:
    - cron: '20 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch5.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-relic:
    uses: ./.github/workflows/test-relic.yml
  
  test-mesos:
    uses: ./.github/workflows/test-mesos.yml
  
  test-split-evaluator:
    uses: ./.github/workflows/test-split-evaluator.yml
  
  test-vtk:
    uses: ./.github/workflows/test-vtk.yml
  
  test-cinder:
    uses: ./.github/workflows/test-cinder.yml
  
  test-tornado:
    uses: ./.github/workflows/test-tornado.yml
  
  test-boringssl:
    uses: ./.github/workflows/test-boringssl.yml
  
  test-libx265:
    uses: ./.github/workflows/test-libx265.yml
  
  test-monkey:
    uses: ./.github/workflows/test-monkey.yml
  
  test-keepalived:
    uses: ./.github/workflows/test-keepalived.yml
  
  test-rocksdbjni:
    uses: ./.github/workflows/test-rocksdbjni.yml
  
  test-scikit-learn:
    uses: ./.github/workflows/test-scikit-learn.yml
  
  test-quartz:
    uses: ./.github/workflows/test-quartz.yml
  
  test-chromium:
    uses: ./.github/workflows/test-chromium.yml
  
  test-pass:
    uses: ./.github/workflows/test-pass.yml
  
  test-kolla:
    uses: ./.github/workflows/test-kolla.yml
  
  test-snapcraft:
    uses: ./.github/workflows/test-snapcraft.yml
  
  test-flink:
    uses: ./.github/workflows/test-flink.yml
  
  test-debian_elts:
    uses: ./.github/workflows/test-debian_elts.yml
  
  test-uv:
    uses: ./.github/workflows/test-uv.yml
  
  test-squid:
    uses: ./.github/workflows/test-squid.yml
  
  test-buildkite-agent:
    uses: ./.github/workflows/test-buildkite-agent.yml
  
  test-istio:
    uses: ./.github/workflows/test-istio.yml
  
  test-evalml:
    uses: ./.github/workflows/test-evalml.yml
  
  test-redundans:
    uses: ./.github/workflows/test-redundans.yml
  
  test-lightgbm:
    uses: ./.github/workflows/test-lightgbm.yml
  
  test-xerces:
    uses: ./.github/workflows/test-xerces.yml
  
  test-rethinkdb:
    uses: ./.github/workflows/test-rethinkdb.yml
  
  test-tensorflow-serving:
    uses: ./.github/workflows/test-tensorflow-serving.yml
  
  test-bonjour:
    uses: ./.github/workflows/test-bonjour.yml
  
  test-horovod-uber:
    uses: ./.github/workflows/test-horovod-uber.yml
  
  test-fftw:
    uses: ./.github/workflows/test-fftw.yml
  
  test-php-gmp:
    uses: ./.github/workflows/test-php-gmp.yml
  
  test-unleash:
    uses: ./.github/workflows/test-unleash.yml
  
  test-cp2k:
    uses: ./.github/workflows/test-cp2k.yml
  
  test-yarn:
    uses: ./.github/workflows/test-yarn.yml
  
  test-multipass:
    uses: ./.github/workflows/test-multipass.yml
  
  test-php-curl:
    uses: ./.github/workflows/test-php-curl.yml
  
  test-rancher:
    uses: ./.github/workflows/test-rancher.yml
  
  test-fltk:
    uses: ./.github/workflows/test-fltk.yml
  
  test-flux:
    uses: ./.github/workflows/test-flux.yml
  
  test-hping:
    uses: ./.github/workflows/test-hping.yml
  
  test-freebsd:
    uses: ./.github/workflows/test-freebsd.yml
  
  test-nfcore:
    uses: ./.github/workflows/test-nfcore.yml
  
  test-v8-javascript:
    uses: ./.github/workflows/test-v8-javascript.yml
  
  test-openfeature_go:
    uses: ./.github/workflows/test-openfeature_go.yml
  
  test-apache_knox:
    uses: ./.github/workflows/test-apache_knox.yml
  
  test-php-fpm:
    uses: ./.github/workflows/test-php-fpm.yml
  

  summary:
    needs:
      [
        test-relic,
        test-mesos,
        test-split-evaluator,
        test-vtk,
        test-cinder,
        test-tornado,
        test-boringssl,
        test-libx265,
        test-monkey,
        test-keepalived,
        test-rocksdbjni,
        test-scikit-learn,
        test-quartz,
        test-chromium,
        test-pass,
        test-kolla,
        test-snapcraft,
        test-flink,
        test-debian_elts,
        test-uv,
        test-squid,
        test-buildkite-agent,
        test-istio,
        test-evalml,
        test-redundans,
        test-lightgbm,
        test-xerces,
        test-rethinkdb,
        test-tensorflow-serving,
        test-bonjour,
        test-horovod-uber,
        test-fftw,
        test-php-gmp,
        test-unleash,
        test-cp2k,
        test-yarn,
        test-multipass,
        test-php-curl,
        test-rancher,
        test-fltk,
        test-flux,
        test-hping,
        test-freebsd,
        test-nfcore,
        test-v8-javascript,
        test-openfeature_go,
        test-apache_knox,
        test-php-fpm
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 5)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 5)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

