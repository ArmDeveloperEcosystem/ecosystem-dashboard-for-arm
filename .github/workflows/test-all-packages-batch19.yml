name: Test All Packages (Batch 19) on Arm64

on:
  workflow_dispatch:
  workflow_call:

jobs:

  test-chef-infra:
    uses: ./.github/workflows/test-chef-infra.yml
  
  test-miniforge:
    uses: ./.github/workflows/test-miniforge.yml

  test-spdlog:
    uses: ./.github/workflows/test-spdlog.yml

  test-redhat-jboss-web-server:
    uses: ./.github/workflows/test-redhat-jboss-web-server.yml
  
  test-parquet:
    uses: ./.github/workflows/test-parquet.yml
  
  test-libconfig:
    uses: ./.github/workflows/test-libconfig.yml
  
  test-srs:
    uses: ./.github/workflows/test-srs.yml
  
  test-openldap:
    uses: ./.github/workflows/test-openldap.yml
  
  test-tuf:
    uses: ./.github/workflows/test-tuf.yml
  
  test-elastic-mockotlpserver:
    uses: ./.github/workflows/test-elastic-mockotlpserver.yml
  
  test-operator-framework:
    uses: ./.github/workflows/test-operator-framework.yml
  
  test-elastic-connector:
    uses: ./.github/workflows/test-elastic-connector.yml
  
  test-openfoam:
    uses: ./.github/workflows/test-openfoam.yml
  
  test-fastdfs:
    uses: ./.github/workflows/test-fastdfs.yml
  
  test-kubevela:
    uses: ./.github/workflows/test-kubevela.yml

  test-docker_compose:
    uses: ./.github/workflows/test-docker_compose.yml
  
  test-erlang:
    uses: ./.github/workflows/test-erlang.yml
  
  test-nebula_graph:
    uses: ./.github/workflows/test-nebula_graph.yml
  
  test-datree:
    uses: ./.github/workflows/test-Datree.yml
  
  test-optipng:
    uses: ./.github/workflows/test-optipng.yml

  test-jemalloc:
    uses: ./.github/workflows/test-jemalloc.yml
  
  test-paraview:
    uses: ./.github/workflows/test-paraview.yml
  
  test-nsq:
    uses: ./.github/workflows/test-nsq.yml

  summary:
    needs:
      [
        test-chef-infra,
        test-miniforge,
        test-spdlog,
        test-redhat-jboss-web-server,
        test-parquet,
        test-libconfig,
        test-srs,
        test-openldap,
        test-tuf,
        test-elastic-mockotlpserver,
        test-operator-framework,
        test-elastic-connector,
        test-openfoam,
        test-fastdfs,
        test-kubevela,
        test-docker_compose,
        test-erlang,
        test-nebula_graph,
        test-datree,
        test-optipng,
        test-jemalloc,
        test-paraview,
        test-nsq
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# ðŸ“Š Package Test Summary (Batch 19)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "âœ… **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "âŒ **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 19)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES âŒ" >> $GITHUB_STEP_SUMMARY


