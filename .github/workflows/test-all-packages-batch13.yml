name: Test All Packages (Batch 13) on Arm64

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch13.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-coredns:
    uses: ./.github/workflows/test-coredns.yml
  
  test-pants:
    uses: ./.github/workflows/test-pants.yml
  
  test-openfeature_python:
    uses: ./.github/workflows/test-openfeature_python.yml
  
  test-split-python-sdk:
    uses: ./.github/workflows/test-split-python-sdk.yml
  
  test-dqlite:
    uses: ./.github/workflows/test-dqlite.yml
  
  test-storm:
    uses: ./.github/workflows/test-storm.yml
  
  test-h2:
    uses: ./.github/workflows/test-h2.yml
  
  test-cri-o:
    uses: ./.github/workflows/test-cri-o.yml
  
  test-spack:
    uses: ./.github/workflows/test-spack.yml
  
  test-apache_thrift:
    uses: ./.github/workflows/test-apache_thrift.yml
  
  test-rubyonrails:
    uses: ./.github/workflows/test-rubyonrails.yml
  
  test-pgadmin4:
    uses: ./.github/workflows/test-pgadmin4.yml
  
  test-llama-index:
    uses: ./.github/workflows/test-llama-index.yml
  
  test-alertmanager:
    uses: ./.github/workflows/test-alertmanager.yml
  
  test-curl:
    uses: ./.github/workflows/test-curl.yml
  
  test-elastic-enterprise-search:
    uses: ./.github/workflows/test-elastic-enterprise-search.yml
  
  test-libopus:
    uses: ./.github/workflows/test-libopus.yml
  
  test-redpanda:
    uses: ./.github/workflows/test-redpanda.yml
  
  test-saspy:
    uses: ./.github/workflows/test-saspy.yml
  
  test-busybox:
    uses: ./.github/workflows/test-busybox.yml
  
  test-joomla:
    uses: ./.github/workflows/test-joomla.yml
  
  test-libvpx:
    uses: ./.github/workflows/test-libvpx.yml
  
  test-weaviate:
    uses: ./.github/workflows/test-weaviate.yml
  
  test-edot-dotnet-sdk:
    uses: ./.github/workflows/test-edot-dotnet-sdk.yml
  
  test-pytorch:
    uses: ./.github/workflows/test-pytorch.yml
  
  test-corosync:
    uses: ./.github/workflows/test-corosync.yml
  
  test-weavenet:
    uses: ./.github/workflows/test-weavenet.yml
  
  test-mezmo:
    uses: ./.github/workflows/test-mezmo.yml
  
  test-docker-ce:
    uses: ./.github/workflows/test-docker-ce.yml
  
  test-onednn:
    uses: ./.github/workflows/test-onednn.yml
  
  test-rook:
    uses: ./.github/workflows/test-rook.yml
  
  test-log4cpp:
    uses: ./.github/workflows/test-log4cpp.yml
  
  test-paddlelite:
    uses: ./.github/workflows/test-paddlelite.yml
  
  test-bishengjdk:
    uses: ./.github/workflows/test-bishengjdk.yml
  
  test-php-cgi:
    uses: ./.github/workflows/test-php-cgi.yml
  
  test-hiredis:
    uses: ./.github/workflows/test-hiredis.yml
  
  test-zed:
    uses: ./.github/workflows/test-zed.yml
  
  test-openresty:
    uses: ./.github/workflows/test-openresty.yml
  
  test-double-conversion:
    uses: ./.github/workflows/test-double-conversion.yml
  
  test-gatsby:
    uses: ./.github/workflows/test-gatsby.yml
  
  test-minio-os:
    uses: ./.github/workflows/test-minio-os.yml
  
  test-mayastor:
    uses: ./.github/workflows/test-mayastor.yml
  
  test-spicedb:
    uses: ./.github/workflows/test-spicedb.yml
  
  test-iguazio_nuclio:
    uses: ./.github/workflows/test-iguazio_nuclio.yml
  
  test-camelk:
    uses: ./.github/workflows/test-camelk.yml
  
  test-filebeat:
    uses: ./.github/workflows/test-filebeat.yml
  
  test-lxc:
    uses: ./.github/workflows/test-lxc.yml
  
  test-zookeeper:
    uses: ./.github/workflows/test-zookeeper.yml
  

  summary:
    needs:
      [
        test-coredns,
        test-pants,
        test-openfeature_python,
        test-split-python-sdk,
        test-dqlite,
        test-storm,
        test-h2,
        test-cri-o,
        test-spack,
        test-apache_thrift,
        test-rubyonrails,
        test-pgadmin4,
        test-llama-index,
        test-alertmanager,
        test-curl,
        test-elastic-enterprise-search,
        test-libopus,
        test-redpanda,
        test-saspy,
        test-busybox,
        test-joomla,
        test-libvpx,
        test-weaviate,
        test-edot-dotnet-sdk,
        test-pytorch,
        test-corosync,
        test-weavenet,
        test-mezmo,
        test-docker-ce,
        test-onednn,
        test-rook,
        test-log4cpp,
        test-paddlelite,
        test-bishengjdk,
        test-php-cgi,
        test-hiredis,
        test-zed,
        test-openresty,
        test-double-conversion,
        test-gatsby,
        test-minio-os,
        test-mayastor,
        test-spicedb,
        test-iguazio_nuclio,
        test-camelk,
        test-filebeat,
        test-lxc,
        test-zookeeper
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 13)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 13)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
