name: Test All Packages (Batch 4) on Arm64

on:
  schedule:
    - cron: '15 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch4.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-0xffff:
    uses: ./.github/workflows/test-0xffff.yml
  
  test-openstack-masakari:
    uses: ./.github/workflows/test-openstack-masakari.yml
  
  test-spire:
    uses: ./.github/workflows/test-spire.yml
  
  test-icu:
    uses: ./.github/workflows/test-icu.yml
  
  test-mesh:
    uses: ./.github/workflows/test-mesh.yml
  
  test-harness-go-sdk:
    uses: ./.github/workflows/test-harness-go-sdk.yml
  
  test-openblas:
    uses: ./.github/workflows/test-openblas.yml
  
  test-logzio:
    uses: ./.github/workflows/test-logzio.yml
  
  test-longhorn:
    uses: ./.github/workflows/test-longhorn.yml
  
  test-netdata:
    uses: ./.github/workflows/test-netdata.yml
  
  test-ultralytics:
    uses: ./.github/workflows/test-ultralytics.yml
  
  test-harbor:
    uses: ./.github/workflows/test-harbor.yml
  
  test-domo-java-sdk:
    uses: ./.github/workflows/test-domo-java-sdk.yml
  
  test-parca:
    uses: ./.github/workflows/test-parca.yml
  
  test-rinetd:
    uses: ./.github/workflows/test-rinetd.yml
  
  test-tdengine:
    uses: ./.github/workflows/test-tdengine.yml
  
  test-php-bcmath:
    uses: ./.github/workflows/test-php-bcmath.yml
  
  test-m4:
    uses: ./.github/workflows/test-m4.yml
  
  test-groff:
    uses: ./.github/workflows/test-groff.yml
  
  test-neuvector:
    uses: ./.github/workflows/test-neuvector.yml
  
  test-kubeedge:
    uses: ./.github/workflows/test-kubeedge.yml
  
  test-openh264:
    uses: ./.github/workflows/test-openh264.yml
  
  test-ray:
    uses: ./.github/workflows/test-ray.yml
  
  test-freetype:
    uses: ./.github/workflows/test-freetype.yml
  
  test-wrk:
    uses: ./.github/workflows/test-wrk.yml
  
  test-boost:
    uses: ./.github/workflows/test-boost.yml
  
  test-llamaindex:
    uses: ./.github/workflows/test-llamaindex.yml
  
  test-solr:
    uses: ./.github/workflows/test-solr.yml
  
  test-eigen:
    uses: ./.github/workflows/test-eigen.yml
  
  test-freetype2:
    uses: ./.github/workflows/test-freetype2.yml
  
  test-hyperledger-fabric:
    uses: ./.github/workflows/test-hyperledger-fabric.yml
  
  test-contour:
    uses: ./.github/workflows/test-contour.yml
  
  test-elastic-ebpf:
    uses: ./.github/workflows/test-elastic-ebpf.yml
  
  test-pandoc:
    uses: ./.github/workflows/test-pandoc.yml
  
  test-glance:
    uses: ./.github/workflows/test-glance.yml
  
  test-seata:
    uses: ./.github/workflows/test-seata.yml
  
  test-cert-manager:
    uses: ./.github/workflows/test-cert-manager.yml
  
  test-python-dlpy:
    uses: ./.github/workflows/test-python-dlpy.yml
  
  test-chisel-operator:
    uses: ./.github/workflows/test-chisel-operator.yml
  
  test-pipenv:
    uses: ./.github/workflows/test-pipenv.yml
  
  test-psutil:
    uses: ./.github/workflows/test-psutil.yml
  
  test-obs:
    uses: ./.github/workflows/test-obs.yml
  
  test-jaeger:
    uses: ./.github/workflows/test-jaeger.yml
  
  test-opensearch-data-prepper:
    uses: ./.github/workflows/test-opensearch-data-prepper.yml
  
  test-ultramarine-linux:
    uses: ./.github/workflows/test-ultramarine-linux.yml
  
  test-pyzmq:
    uses: ./.github/workflows/test-pyzmq.yml
  
  test-libx264:
    uses: ./.github/workflows/test-libx264.yml
  
  test-torchtune:
    uses: ./.github/workflows/test-torchtune.yml
  

  summary:
    needs:
      [
        test-0xffff,
        test-openstack-masakari,
        test-spire,
        test-icu,
        test-mesh,
        test-harness-go-sdk,
        test-openblas,
        test-logzio,
        test-longhorn,
        test-netdata,
        test-ultralytics,
        test-harbor,
        test-domo-java-sdk,
        test-parca,
        test-rinetd,
        test-tdengine,
        test-php-bcmath,
        test-m4,
        test-groff,
        test-neuvector,
        test-kubeedge,
        test-openh264,
        test-ray,
        test-freetype,
        test-wrk,
        test-boost,
        test-llamaindex,
        test-solr,
        test-eigen,
        test-freetype2,
        test-hyperledger-fabric,
        test-contour,
        test-elastic-ebpf,
        test-pandoc,
        test-glance,
        test-seata,
        test-cert-manager,
        test-python-dlpy,
        test-chisel-operator,
        test-pipenv,
        test-psutil,
        test-obs,
        test-jaeger,
        test-opensearch-data-prepper,
        test-ultramarine-linux,
        test-pyzmq,
        test-libx264,
        test-torchtune
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 4)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 4)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
