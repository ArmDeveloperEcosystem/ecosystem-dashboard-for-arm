name: Test All Packages (Batch 17) on Arm64

on:
  schedule:
    - cron: '20 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch17.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-quilt:
    uses: ./.github/workflows/test-quilt.yml
  
  test-openeuler:
    uses: ./.github/workflows/test-openeuler.yml
  
  test-apache_ant:
    uses: ./.github/workflows/test-apache_ant.yml
  
  test-karmada:
    uses: ./.github/workflows/test-karmada.yml
  
  test-mesa:
    uses: ./.github/workflows/test-mesa.yml
  
  test-sysdig:
    uses: ./.github/workflows/test-sysdig.yml
  
  test-cockroachdb:
    uses: ./.github/workflows/test-cockroachdb.yml
  
  test-trino:
    uses: ./.github/workflows/test-trino.yml
  
  test-vespa-open-source:
    uses: ./.github/workflows/test-vespa-open-source.yml
  
  test-dpdk:
    uses: ./.github/workflows/test-DPDK.yml
  
  test-mosquitto:
    uses: ./.github/workflows/test-mosquitto.yml
  
  test-repeatscout:
    uses: ./.github/workflows/test-repeatscout.yml

  test-wrf:
    uses: ./.github/workflows/test-wrf.yml
  
  test-linuxkit:
    uses: ./.github/workflows/test-linuxkit.yml
  
  test-qemu:
    uses: ./.github/workflows/test-qemu.yml
  
  test-xmlsec:
    uses: ./.github/workflows/test-xmlsec.yml
  
  test-xebium:
    uses: ./.github/workflows/test-xebium.yml
  
  test-picassojs:
    uses: ./.github/workflows/test-picassoJS.yml
  
  test-couchbase:
    uses: ./.github/workflows/test-couchbase.yml
  
  test-ycsb:
    uses: ./.github/workflows/test-ycsb.yml
  
  test-lachesis:
    uses: ./.github/workflows/test-Lachesis.yml
  
  test-clang:
    uses: ./.github/workflows/test-clang.yml
  
  test-re2c:
    uses: ./.github/workflows/test-re2c.yml
  
  test-cashpack:
    uses: ./.github/workflows/test-cashpack.yml
  
  test-kmerfreq:
    uses: ./.github/workflows/test-kmerfreq.yml

  test-druid:
    uses: ./.github/workflows/test-druid.yml
  
  test-gitness:
    uses: ./.github/workflows/test-gitness.yml
  
  test-psmc:
    uses: ./.github/workflows/test-psmc.yml
  
  test-salt:
    uses: ./.github/workflows/test-salt.yml
  
  test-glew:
    uses: ./.github/workflows/test-glew.yml
  
  test-chaos-mesh:
    uses: ./.github/workflows/test-chaos-mesh.yml
  
  test-pulumi:
    uses: ./.github/workflows/test-pulumi.yml
  
  test-litmus:
    uses: ./.github/workflows/test-litmus.yml
  
  test-munge:
    uses: ./.github/workflows/test-munge.yml
  
  test-numpy:
    uses: ./.github/workflows/test-numpy.yml
  
  test-grafanalib:
    uses: ./.github/workflows/test-grafanalib.yml
  
  test-libdrm:
    uses: ./.github/workflows/test-libdrm.yml
  
  test-libxcb:
    uses: ./.github/workflows/test-libxcb.yml
  
  test-openssl:
    uses: ./.github/workflows/test-openssl.yml
  
  test-libxext:
    uses: ./.github/workflows/test-libXext.yml
  
  test-openfeature_java:
    uses: ./.github/workflows/test-openfeature_java.yml
  
  test-perl:
    uses: ./.github/workflows/test-perl.yml
  
  test-spring-cloud-openfeign:
    uses: ./.github/workflows/test-spring-cloud-openfeign.yml
  
  test-thoughtworks_talisman:
    uses: ./.github/workflows/test-thoughtworks_talisman.yml
  
  test-wasmtime:
    uses: ./.github/workflows/test-wasmtime.yml
  
  test-wireshark:
    uses: ./.github/workflows/test-wireshark.yml

  summary:
    needs:
      [
        test-quilt,
        test-openeuler,
        test-apache_ant,
        test-karmada,
        test-mesa,
        test-sysdig,
        test-cockroachdb,
        test-trino,
        test-vespa-open-source,
        test-dpdk,
        test-mosquitto,
        test-repeatscout,
        test-pgbouncer,
        test-wrf,
        test-linuxkit,
        test-qemu,
        test-xmlsec,
        test-xebium,
        test-picassojs,
        test-couchbase,
        test-ycsb,
        test-lachesis,
        test-clang,
        test-re2c,
        test-cashpack,
        test-kmerfreq,
        test-yambo,
        test-druid,
        test-gitness,
        test-psmc,
        test-salt,
        test-glew,
        test-chaos-mesh,
        test-pulumi,
        test-litmus,
        test-munge,
        test-numpy,
        test-grafanalib,
        test-libdrm,
        test-libxcb,
        test-openssl,
        test-libxext,
        test-openfeature_java,
        test-perl,
        test-spring-cloud-openfeign,
        test-thoughtworks_talisman,
        test-wasmtime,
        test-wireshark
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 17)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 17)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

