name: Test All Packages (Batch 8) on Arm64

on:
  schedule:
    - cron: '35 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch8.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-shopify:
    uses: ./.github/workflows/test-shopify.yml
  
  test-lighttpd:
    uses: ./.github/workflows/test-lighttpd.yml
  
  test-minimap:
    uses: ./.github/workflows/test-minimap.yml
  
  test-libmpc:
    uses: ./.github/workflows/test-libmpc.yml
  
  test-elemental-toolkit:
    uses: ./.github/workflows/test-elemental-toolkit.yml
  
  test-pgloader:
    uses: ./.github/workflows/test-pgloader.yml
  
  test-kafkacat:
    uses: ./.github/workflows/test-kafkacat.yml
  
  test-huggingface_trasformers:
    uses: ./.github/workflows/test-huggingface_trasformers.yml
  
  test-picard:
    uses: ./.github/workflows/test-picard.yml
  
  test-enigmajs:
    uses: ./.github/workflows/test-enigmaJS.yml
  
  test-zulip:
    uses: ./.github/workflows/test-zulip.yml
  
  test-langchain:
    uses: ./.github/workflows/test-langchain.yml
  
  test-libfastcommon:
    uses: ./.github/workflows/test-libfastcommon.yml
  
  test-php-ast:
    uses: ./.github/workflows/test-php-ast.yml
  
  test-tinyproxy:
    uses: ./.github/workflows/test-tinyproxy.yml
  
  test-azul_system:
    uses: ./.github/workflows/test-azul_system.yml
  
  test-opengauss:
    uses: ./.github/workflows/test-opengauss.yml
  
  test-ory:
    uses: ./.github/workflows/test-ory.yml
  
  test-nagioscore:
    uses: ./.github/workflows/test-nagioscore.yml
  
  test-dnsmasq:
    uses: ./.github/workflows/test-dnsmasq.yml
  
  test-microk8s:
    uses: ./.github/workflows/test-microk8s.yml
  
  test-scala:
    uses: ./.github/workflows/test-scala.yml
  
  test-liboqs:
    uses: ./.github/workflows/test-liboqs.yml
  
  test-rabbitmq:
    uses: ./.github/workflows/test-rabbitmq.yml
  
  test-r:
    uses: ./.github/workflows/test-R.yml
  
  test-submarine:
    uses: ./.github/workflows/test-submarine.yml
  
  test-opensuse-leap:
    uses: ./.github/workflows/test-opensuse-leap.yml
  
  test-zipkin:
    uses: ./.github/workflows/test-Zipkin.yml
  
  test-streamlit:
    uses: ./.github/workflows/test-streamlit.yml
  
  test-edot-collector:
    uses: ./.github/workflows/test-edot-collector.yml
  
  test-libreoffice:
    uses: ./.github/workflows/test-libreoffice.yml
  
  test-vsftpd:
    uses: ./.github/workflows/test-vsftpd.yml
  
  test-orientdb:
    uses: ./.github/workflows/test-orientdb.yml
  
  test-k3s:
    uses: ./.github/workflows/test-k3s.yml
  
  test-netbsd:
    uses: ./.github/workflows/test-netbsd.yml
  
  test-opencart:
    uses: ./.github/workflows/test-opencart.yml
  
  test-wildfly:
    uses: ./.github/workflows/test-wildfly.yml
  
  test-yugabytedb:
    uses: ./.github/workflows/test-yugabytedb.yml
  
  test-fleet:
    uses: ./.github/workflows/test-fleet.yml
  
  test-porting_advisor:
    uses: ./.github/workflows/test-porting_advisor.yml
  
  test-sphinx:
    uses: ./.github/workflows/test-sphinx.yml
  
  test-gitbook:
    uses: ./.github/workflows/test-gitbook.yml
  
  test-fluentd:
    uses: ./.github/workflows/test-fluentd.yml
  
  test-sentry-python:
    uses: ./.github/workflows/test-sentry-python.yml
  
  test-cloudevents-java:
    uses: ./.github/workflows/test-cloudevents-java.yml
  
  test-odp:
    uses: ./.github/workflows/test-ODP.yml
  
  test-tidb:
    uses: ./.github/workflows/test-TiDB.yml
  
  test-dentos:
    uses: ./.github/workflows/test-dentos.yml
  

  summary:
    needs:
      [
        test-shopify,
        test-lighttpd,
        test-minimap,
        test-libmpc,
        test-elemental-toolkit,
        test-pgloader,
        test-kafkacat,
        test-huggingface_trasformers,
        test-picard,
        test-enigmajs,
        test-zulip,
        test-langchain,
        test-libfastcommon,
        test-php-ast,
        test-tinyproxy,
        test-azul_system,
        test-opengauss,
        test-ory,
        test-nagioscore,
        test-dnsmasq,
        test-microk8s,
        test-scala,
        test-liboqs,
        test-rabbitmq,
        test-r,
        test-submarine,
        test-opensuse-leap,
        test-zipkin,
        test-streamlit,
        test-edot-collector,
        test-libreoffice,
        test-vsftpd,
        test-orientdb,
        test-k3s,
        test-netbsd,
        test-opencart,
        test-wildfly,
        test-yugabytedb,
        test-fleet,
        test-porting_advisor,
        test-sphinx,
        test-gitbook,
        test-fluentd,
        test-sentry-python,
        test-cloudevents-java,
        test-odp,
        test-tidb,
        test-dentos
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 8)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 8)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

