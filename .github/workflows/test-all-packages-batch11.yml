name: Test All Packages (Batch 11) on Arm64

on:
  schedule:
    - cron: '50 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch11.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-sentry-javascript:
    uses: ./.github/workflows/test-sentry-javascript.yml
  
  test-popins2:
    uses: ./.github/workflows/test-popins2.yml
  
  test-heartbeat:
    uses: ./.github/workflows/test-heartbeat.yml
  
  test-snappy:
    uses: ./.github/workflows/test-snappy.yml
  
  test-sonarqube:
    uses: ./.github/workflows/test-sonarqube.yml
  
  test-oceanbase:
    uses: ./.github/workflows/test-oceanbase.yml
  
  test-julia:
    uses: ./.github/workflows/test-julia.yml
  
  test-epdb:
    uses: ./.github/workflows/test-epdb.yml
  
  test-gmsh:
    uses: ./.github/workflows/test-gmsh.yml
  
  test-llvm:
    uses: ./.github/workflows/test-llvm.yml
  
  test-luajit:
    uses: ./.github/workflows/test-luajit.yml
  
  test-junit5:
    uses: ./.github/workflows/test-junit5.yml
  
  test-junit:
    uses: ./.github/workflows/test-junit.yml
  
  test-vectorscan:
    uses: ./.github/workflows/test-vectorscan.yml
  
  test-nwchem:
    uses: ./.github/workflows/test-nwchem.yml
  
  test-tengine:
    uses: ./.github/workflows/test-tengine.yml
  
  test-pixman:
    uses: ./.github/workflows/test-pixman.yml
  
  test-freeglut:
    uses: ./.github/workflows/test-freeglut.yml
  
  test-php-zip:
    uses: ./.github/workflows/test-php-zip.yml
  
  test-tez:
    uses: ./.github/workflows/test-tez.yml
  
  test-libpcap:
    uses: ./.github/workflows/test-libpcap.yml
  
  test-phpmyadmin:
    uses: ./.github/workflows/test-phpmyadmin.yml
  
  test-featuretools:
    uses: ./.github/workflows/test-featuretools.yml
  
  test-emqtt:
    uses: ./.github/workflows/test-emqtt.yml
  
  test-openfalcon:
    uses: ./.github/workflows/test-openfalcon.yml
  
  test-containerd:
    uses: ./.github/workflows/test-containerd.yml
  
  test-rocky_linux:
    uses: ./.github/workflows/test-rocky_linux.yml
  
  test-llvm_flang:
    uses: ./.github/workflows/test-llvm_flang.yml
  
  test-minio:
    uses: ./.github/workflows/test-minio.yml
  
  test-platformio:
    uses: ./.github/workflows/test-platformio.yml
  
  test-ocaml:
    uses: ./.github/workflows/test-ocaml.yml
  
  test-php-bz2:
    uses: ./.github/workflows/test-php-bz2.yml
  
  test-pgtap:
    uses: ./.github/workflows/test-pgtap.yml
  
  test-drupal:
    uses: ./.github/workflows/test-drupal.yml
  
  test-mariadb:
    uses: ./.github/workflows/test-mariadb.yml
  
  test-bioconda:
    uses: ./.github/workflows/test-bioconda.yml
  
  test-glog:
    uses: ./.github/workflows/test-glog.yml
  
  test-opentelemetry-cpp:
    uses: ./.github/workflows/test-opentelemetry-cpp.yml
  
  test-curve:
    uses: ./.github/workflows/test-curve.yml
  
  test-ignite:
    uses: ./.github/workflows/test-ignite.yml
  
  test-jitsi:
    uses: ./.github/workflows/test-jitsi.yml
  
  test-elastic-quark:
    uses: ./.github/workflows/test-elastic-quark.yml
  
  test-spacy:
    uses: ./.github/workflows/test-spacy.yml
  
  test-immudb:
    uses: ./.github/workflows/test-immudb.yml
  
  test-isa-l:
    uses: ./.github/workflows/test-isa-l.yml
  
  test-stream:
    uses: ./.github/workflows/test-stream.yml
  
  test-minikube:
    uses: ./.github/workflows/test-minikube.yml
  
  test-grpc:
    uses: ./.github/workflows/test-grpc.yml
  

  summary:
    needs:
      [
        test-sentry-javascript,
        test-popins2,
        test-heartbeat,
        test-snappy,
        test-sonarqube,
        test-oceanbase,
        test-julia,
        test-epdb,
        test-gmsh,
        test-llvm,
        test-luajit,
        test-junit5,
        test-junit,
        test-vectorscan,
        test-nwchem,
        test-tengine,
        test-pixman,
        test-freeglut,
        test-php-zip,
        test-tez,
        test-libpcap,
        test-phpmyadmin,
        test-featuretools,
        test-emqtt,
        test-openfalcon,
        test-containerd,
        test-rocky_linux,
        test-llvm_flang,
        test-minio,
        test-platformio,
        test-ocaml,
        test-php-bz2,
        test-pgtap,
        test-drupal,
        test-mariadb,
        test-bioconda,
        test-glog,
        test-opentelemetry-cpp,
        test-curve,
        test-ignite,
        test-jitsi,
        test-elastic-quark,
        test-spacy,
        test-immudb,
        test-isa-l,
        test-stream,
        test-minikube,
        test-grpc
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 11)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 11)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
