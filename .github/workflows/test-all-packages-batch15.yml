name: Test All Packages (Batch 15) on Arm64

on:
  schedule:
    - cron: '10 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch15.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-fping:
    uses: ./.github/workflows/test-fping.yml
  
  test-strongswan:
    uses: ./.github/workflows/test-strongswan.yml
  
  test-highwayhash:
    uses: ./.github/workflows/test-highwayhash.yml
  
  test-sendbird-uikit:
    uses: ./.github/workflows/test-sendbird-uikit.yml
  
  test-gromacs:
    uses: ./.github/workflows/test-gromacs.yml
  
  test-metallb:
    uses: ./.github/workflows/test-metallb.yml
  
  test-rke:
    uses: ./.github/workflows/test-RKE.yml
  
  test-neutron:
    uses: ./.github/workflows/test-Neutron.yml
  
  test-luarocks:
    uses: ./.github/workflows/test-luarocks.yml
  
  test-keptn:
    uses: ./.github/workflows/test-keptn.yml
  
  test-glibc:
    uses: ./.github/workflows/test-glibc.yml
  
  test-mopac:
    uses: ./.github/workflows/test-mopac.yml
  
  test-dubbo-go:
    uses: ./.github/workflows/test-dubbo-go.yml
  
  test-elastic-package:
    uses: ./.github/workflows/test-elastic-package.yml
  
  test-gperf:
    uses: ./.github/workflows/test-gperf.yml
  
  test-scipy:
    uses: ./.github/workflows/test-scipy.yml
  
  test-litespeed_openlitespeed:
    uses: ./.github/workflows/test-litespeed_openlitespeed.yml
  
  test-mummer:
    uses: ./.github/workflows/test-mummer.yml
  
  test-python:
    uses: ./.github/workflows/test-python.yml
  
  test-ironic:
    uses: ./.github/workflows/test-ironic.yml
  
  test-journalbeat:
    uses: ./.github/workflows/test-journalbeat.yml
  
  test-ipvsadm:
    uses: ./.github/workflows/test-ipvsadm.yml
  
  test-woocommerce:
    uses: ./.github/workflows/test-woocommerce.yml
  
  test-gvisor:
    uses: ./.github/workflows/test-gVisor.yml
  
  test-iniparser:
    uses: ./.github/workflows/test-iniParser.yml
  
  test-pdns:
    uses: ./.github/workflows/test-pdns.yml
  
  test-protobuf:
    uses: ./.github/workflows/test-protobuf.yml
  
  test-opencas:
    uses: ./.github/workflows/test-opencas.yml
  
  test-dynamorio:
    uses: ./.github/workflows/test-dynamorio.yml
  
  test-elasticapmagent:
    uses: ./.github/workflows/test-elasticapmagent.yml
  
  test-php-readline:
    uses: ./.github/workflows/test-php-readline.yml
  
  test-cmake:
    uses: ./.github/workflows/test-cmake.yml
  
  test-kubermatics:
    uses: ./.github/workflows/test-kubermatics.yml
  
  test-opencv:
    uses: ./.github/workflows/test-opencv.yml
  
  test-dubbo-java:
    uses: ./.github/workflows/test-dubbo-java.yml
  
  test-pyinstaller:
    uses: ./.github/workflows/test-pyinstaller.yml
  
  test-whisper:
    uses: ./.github/workflows/test-whisper.yml
  
  test-muscle:
    uses: ./.github/workflows/test-muscle.yml
  
  test-slurm:
    uses: ./.github/workflows/test-slurm.yml
  
  test-eman2:
    uses: ./.github/workflows/test-eman2.yml
  
  test-swift:
    uses: ./.github/workflows/test-swift.yml
  
  test-mlflow:
    uses: ./.github/workflows/test-mlflow.yml
  
  test-ecctl:
    uses: ./.github/workflows/test-ecctl.yml
  
  test-bosh-cli:
    uses: ./.github/workflows/test-bosh-cli.yml
  
  test-php-opcache:
    uses: ./.github/workflows/test-php-opcache.yml
  
  test-greenplum:
    uses: ./.github/workflows/test-greenplum.yml
  
  test-jetty:
    uses: ./.github/workflows/test-jetty.yml
  
  test-spring-cloud-stream:
    uses: ./.github/workflows/test-spring-cloud-stream.yml
  

  summary:
    needs:
      [
        test-fping,
        test-strongswan,
        test-highwayhash,
        test-sendbird-uikit,
        test-gromacs,
        test-metallb,
        test-rke,
        test-neutron,
        test-luarocks,
        test-keptn,
        test-glibc,
        test-mopac,
        test-dubbo-go,
        test-elastic-package,
        test-gperf,
        test-scipy,
        test-litespeed_openlitespeed,
        test-mummer,
        test-python,
        test-ironic,
        test-journalbeat,
        test-ipvsadm,
        test-woocommerce,
        test-gvisor,
        test-iniparser,
        test-pdns,
        test-protobuf,
        test-opencas,
        test-dynamorio,
        test-elasticapmagent,
        test-php-readline,
        test-cmake,
        test-kubermatics,
        test-opencv,
        test-dubbo-java,
        test-pyinstaller,
        test-whisper,
        test-muscle,
        test-slurm,
        test-eman2,
        test-swift,
        test-mlflow,
        test-ecctl,
        test-bosh-cli,
        test-php-opcache,
        test-greenplum,
        test-jetty,
        test-spring-cloud-stream
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 15)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 15)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

