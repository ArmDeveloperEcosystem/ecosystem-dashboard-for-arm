name: Test All Packages (Batch 7) on Arm64

on:
  workflow_dispatch:
  workflow_call:
jobs:
  test-ffmpeg:
    uses: ./.github/workflows/test-ffmpeg.yml
  
  test-chroma:
    uses: ./.github/workflows/test-chroma.yml
  
  test-mediawiki:
    uses: ./.github/workflows/test-mediawiki.yml
  
  test-openmpi:
    uses: ./.github/workflows/test-openmpi.yml
  
  test-iperf:
    uses: ./.github/workflows/test-iperf.yml
  
  test-lucene:
    uses: ./.github/workflows/test-lucene.yml
  
  test-vpp:
    uses: ./.github/workflows/test-vpp.yml
  
  test-hive:
    uses: ./.github/workflows/test-hive.yml

  test-rmblast:
    uses: ./.github/workflows/test-rmblast.yml
  
  test-minio-mc:
    uses: ./.github/workflows/test-minio-mc.yml
  
  test-kyverno:
    uses: ./.github/workflows/test-kyverno.yml
  
  test-keycloak:
    uses: ./.github/workflows/test-keycloak.yml
  
  test-debian:
    uses: ./.github/workflows/test-debian.yml
  
  test-bison:
    uses: ./.github/workflows/test-bison.yml
  
  test-beanstalkd:
    uses: ./.github/workflows/test-beanstalkd.yml
  
  test-predixy:
    uses: ./.github/workflows/test-predixy.yml
  
  test-gdal:
    uses: ./.github/workflows/test-gdal.yml
  
  test-snort:
    uses: ./.github/workflows/test-snort.yml
  
  test-electron:
    uses: ./.github/workflows/test-electron.yml
  
  test-php:
    uses: ./.github/workflows/test-php.yml
  
  test-databend:
    uses: ./.github/workflows/test-databend.yml
  
  test-uui:
    uses: ./.github/workflows/test-uui.yml
  
  test-samba:
    uses: ./.github/workflows/test-samba.yml
  
  test-phoronix_test_suite:
    uses: ./.github/workflows/test-phoronix_test_suite.yml
  
  test-lapack:
    uses: ./.github/workflows/test-lapack.yml
  
  test-zeroc_ice:
    uses: ./.github/workflows/test-zeroc_ice.yml
  
  test-dm:
    uses: ./.github/workflows/test-dm.yml
  
  test-victoriametrics:
    uses: ./.github/workflows/test-victoriametrics.yml
  
  test-varnish:
    uses: ./.github/workflows/test-varnish.yml
  
  test-percona:
    uses: ./.github/workflows/test-percona.yml
  
  test-lmbench:
    uses: ./.github/workflows/test-lmbench.yml

  test-vllm:
    uses: ./.github/workflows/test-vllm.yml
  
  test-netplan:
    uses: ./.github/workflows/test-netplan.yml
  
  test-emqx:
    uses: ./.github/workflows/test-emqx.yml
  
  test-asp-net:
    uses: ./.github/workflows/test-asp-net.yml
  
  test-kylin:
    uses: ./.github/workflows/test-kylin.yml
  
  test-chaossearch:
    uses: ./.github/workflows/test-chaossearch.yml
  
  test-benchmarksql:
    uses: ./.github/workflows/test-benchmarksql.yml
  
  test-opencascade:
    uses: ./.github/workflows/test-opencascade.yml
  
  test-buildpacks:
    uses: ./.github/workflows/test-buildpacks.yml

  test-sonic:
    uses: ./.github/workflows/test-sonic.yml
  
  test-opentelemetry-go:
    uses: ./.github/workflows/test-opentelemetry-go.yml
  
  test-kube-router:
    uses: ./.github/workflows/test-kube-router.yml
  
  test-postgis:
    uses: ./.github/workflows/test-postgis.yml

  summary:
    needs:
      [
        test-ffmpeg,
        test-chroma,
        test-mediawiki,
        test-openmpi,
        test-iperf,
        test-lucene,
        test-vpp,
        test-hive,
        test-rmblast,
        test-minio-mc,
        test-kyverno,
        test-keycloak,
        test-debian,
        test-bison,
        test-beanstalkd,
        test-predixy,
        test-gdal,
        test-snort,
        test-electron,
        test-php,
        test-databend,
        test-uui,
        test-samba,
        test-phoronix_test_suite,
        test-lapack,
        test-zeroc_ice,
        test-dm,
        test-victoriametrics,
        test-varnish,
        test-percona,
        test-lmbench,
        test-vllm,
        test-netplan,
        test-emqx,
        test-asp-net,
        test-kylin,
        test-chaossearch,
        test-benchmarksql,
        test-opencascade,
        test-buildpacks,
        test-sonic,
        test-opentelemetry-go,
        test-kube-router,
        test-postgis
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# ðŸ“Š Package Test Summary (Batch 7)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "âœ… **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "âŒ **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 7)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES âŒ" >> $GITHUB_STEP_SUMMARY

