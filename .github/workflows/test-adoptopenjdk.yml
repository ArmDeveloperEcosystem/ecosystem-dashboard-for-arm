name: Test AdoptOpenJDK on Arm64

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/adoptopenjdk.md'
      - '.github/workflows/test-adoptopenjdk.yml'

jobs:
  test-adoptopenjdk:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set test metadata
      id: metadata
      run: |
        echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
        echo "package_slug=adoptopenjdk" >> $GITHUB_OUTPUT
        echo "dashboard_link=/opensource_packages/adoptopenjdk" >> $GITHUB_OUTPUT

    # ============================================================
    # Install AdoptOpenJDK (Eclipse Temurin) JDK 21
    # ============================================================
    - name: Install Eclipse Temurin JDK 21
      id: install
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '21'

    # ============================================================
    # Get Java version
    # ============================================================
    - name: Get AdoptOpenJDK version
      id: version
      run: |
        RAW=$(java -version 2>&1 || true)
        echo "Raw 'java -version' output:"
        echo "$RAW"

        # Extract major version (e.g., 21)
        VERSION=$(echo "$RAW" | grep -oE '\"[0-9]+' | head -1 | tr -d '"' || true)

        if [ -z "$VERSION" ]; then
          VERSION="21"
        fi

        echo "Detected AdoptOpenJDK/Temurin version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # ============================================================
    # Tests (5 meaningful smoke tests)
    # ============================================================

    - name: Test 1 - Check java binary exists
      id: test1
      run: |
        START_TIME=$(date +%s)

        if command -v java &> /dev/null; then
          echo "✓ java binary found"
          which java || true
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "✗ java binary not found"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        END_TIME=$(date +%s)
        echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

    - name: Test 2 - Check javac binary exists
      id: test2
      run: |
        START_TIME=$(date +%s)

        if command -v javac &> /dev/null; then
          echo "✓ javac compiler binary found"
          which javac || true
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "✗ javac compiler binary not found"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        END_TIME=$(date +%s)
        echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

    - name: Test 3 - Check java -version output includes 21
      id: test3
      run: |
        START_TIME=$(date +%s)

        OUTPUT=$(java -version 2>&1 || true)
        echo "$OUTPUT"

        if echo "$OUTPUT" | grep -q "21"; then
          echo "✓ java -version reports a 21.x JDK"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "✗ java -version does not clearly report a 21.x JDK"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        END_TIME=$(date +%s)
        echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

    - name: Test 4 - Compile and run HelloWorld
      id: test4
      run: |
        START_TIME=$(date +%s)

        cat << 'EOF' > Hello.java
        public class Hello {
            public static void main(String[] args) {
                System.out.println("Hello Arm");
            }
        }
        EOF

        if ! javac Hello.java; then
          echo "✗ Failed to compile Hello.java with javac"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        OUTPUT=$(java Hello 2>&1 || true)
        echo "Program output: $OUTPUT"

        if [ "$OUTPUT" = "Hello Arm" ]; then
          echo "✓ HelloWorld compiled and ran successfully"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "✗ HelloWorld output unexpected"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        END_TIME=$(date +%s)
        echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

    - name: Test 5 - Check JAVA_HOME sanity
      id: test5
      run: |
        START_TIME=$(date +%s)

        # actions/setup-java exports JAVA_HOME
        if [ -n "${JAVA_HOME:-}" ] && [ -x "${JAVA_HOME}/bin/java" ]; then
          echo "✓ JAVA_HOME is set and points to a JDK (${JAVA_HOME})"
          echo "status=passed" >> $GITHUB_OUTPUT
        else
          echo "✗ JAVA_HOME is not set correctly or java not found under JAVA_HOME"
          echo "JAVA_HOME='${JAVA_HOME:-}'"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        END_TIME=$(date +%s)
        echo "duration=$((END_TIME - START_TIME))" >> $GITHUB_OUTPUT

    # ============================================================
    # Calculate test summary
    # ============================================================
    - name: Calculate test summary
      if: always()
      id: summary
      run: |
        PASSED=0
        FAILED=0
        TOTAL_DURATION=0

        # Test 1
        if [ "${{ steps.test1.outputs.status }}" == "passed" ]; then
          PASSED=$((PASSED + 1))
        else
          FAILED=$((FAILED + 1))
        fi
        TOTAL_DURATION=$((TOTAL_DURATION + ${{ steps.test1.outputs.duration || 0 }}))

        # Test 2
        if [ "${{ steps.test2.outputs.status }}" == "passed" ]; then
          PASSED=$((PASSED + 1))
        else
          FAILED=$((FAILED + 1))
        fi
        TOTAL_DURATION=$((TOTAL_DURATION + ${{ steps.test2.outputs.duration || 0 }}))

        # Test 3
        if [ "${{ steps.test3.outputs.status }}" == "passed" ]; then
          PASSED=$((PASSED + 1))
        else
          FAILED=$((FAILED + 1))
        fi
        TOTAL_DURATION=$((TOTAL_DURATION + ${{ steps.test3.outputs.duration || 0 }}))

        # Test 4
        if [ "${{ steps.test4.outputs.status }}" == "passed" ]; then
          PASSED=$((PASSED + 1))
        else
          FAILED=$((FAILED + 1))
        fi
        TOTAL_DURATION=$((TOTAL_DURATION + ${{ steps.test4.outputs.duration || 0 }}))

        # Test 5
        if [ "${{ steps.test5.outputs.status }}" == "passed" ]; then
          PASSED=$((PASSED + 1))
        else
          FAILED=$((FAILED + 1))
        fi
        TOTAL_DURATION=$((TOTAL_DURATION + ${{ steps.test5.outputs.duration || 0 }}))

        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "duration=$TOTAL_DURATION" >> $GITHUB_OUTPUT

        if [ $FAILED -eq 0 ]; then
          echo "overall_status=success" >> $GITHUB_OUTPUT
          echo "badge_status=passing" >> $GITHUB_OUTPUT
        else
          echo "overall_status=failure" >> $GITHUB_OUTPUT
          echo "badge_status=failing" >> $GITHUB_OUTPUT
        fi

    # ============================================================
    # Generate test results JSON
    # ============================================================
    - name: Generate test results JSON
      if: always()
      run: |
        mkdir -p test-results

        cat > test-results/adoptopenjdk.json << EOF
        {
          "schema_version": "1.0",
          "package": {
            "name": "AdoptOpenJDK",
            "version": "${{ steps.version.outputs.version }}",
            "language": "Java",
            "category": "Miscellaneous"
          },
          "run": {
            "id": "${{ github.run_id }}",
            "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
            "timestamp": "${{ steps.metadata.outputs.timestamp }}",
            "status": "${{ steps.summary.outputs.overall_status }}",
            "runner": {
              "os": "ubuntu-24.04",
              "arch": "arm64"
            }
          },
          "tests": {
            "passed": ${{ steps.summary.outputs.passed }},
            "failed": ${{ steps.summary.outputs.failed }},
            "skipped": 0,
            "duration_seconds": ${{ steps.summary.outputs.duration }},
            "details": [
              {
                "name": "Check java binary exists",
                "status": "${{ steps.test1.outputs.status }}",
                "duration_seconds": ${{ steps.test1.outputs.duration || 0 }}
              },
              {
                "name": "Check javac binary exists",
                "status": "${{ steps.test2.outputs.status }}",
                "duration_seconds": ${{ steps.test2.outputs.duration || 0 }}
              },
              {
                "name": "Check java -version output includes 21",
                "status": "${{ steps.test3.outputs.status }}",
                "duration_seconds": ${{ steps.test3.outputs.duration || 0 }}
              },
              {
                "name": "Compile and run HelloWorld",
                "status": "${{ steps.test4.outputs.status }}",
                "duration_seconds": ${{ steps.test4.outputs.duration || 0 }}
              },
              {
                "name": "Check JAVA_HOME sanity",
                "status": "${{ steps.test5.outputs.status }}",
                "duration_seconds": ${{ steps.test5.outputs.duration || 0 }}
              }
            ]
          },
          "metadata": {
            "dashboard_link": "${{ steps.metadata.outputs.dashboard_link }}",
            "badge_status": "${{ steps.summary.outputs.badge_status }}"
          }
        }
        EOF

        echo "Generated test results:"
        cat test-results/adoptopenjdk.json

    # ============================================================
    # STANDARD STEPS - Upload + commit results
    # ============================================================
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: adoptopenjdk-test-results
        path: test-results/adoptopenjdk.json
        retention-days: 90

    - name: Commit test results to repository
      if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/smoke_tests')
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        mkdir -p data/test-results
        cp test-results/adoptopenjdk.json data/test-results/adoptopenjdk.json

        git add data/test-results/adoptopenjdk.json

        if ! git diff --staged --quiet; then
          git commit -m "Update adoptopenjdk test results [skip ci]"

          # Pull with rebase and push, retry up to 5 times
          for i in {1..5}; do
            if git pull --rebase origin ${{ github.ref_name }}; then
              if git push; then
                echo "Successfully pushed test results"
                break
              fi
            else
              echo "Rebase failed, resolving conflicts..."

              git checkout --ours data/test-results/adoptopenjdk.json
              git add data/test-results/adoptopenjdk.json
              git rebase --continue || true
            fi

            echo "Retry attempt $i of 5..."
            sleep $((i * 2))
          done
        else
          echo "No changes to commit"
        fi

    - name: Create test summary
      if: always()
      run: |
        echo "## AdoptOpenJDK Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ steps.summary.outputs.overall_status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Passed:** ${{ steps.summary.outputs.passed }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests Failed:** ${{ steps.summary.outputs.failed }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Duration:** ${{ steps.summary.outputs.duration }}s" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner:** ubuntu-24.04 (arm64)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Details" >> $GITHUB_STEP_SUMMARY
        echo "1. Check java binary exists: ${{ steps.test1.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "2. Check javac binary exists: ${{ steps.test2.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "3. Check java -version output includes 21: ${{ steps.test3.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "4. Compile and run HelloWorld: ${{ steps.test4.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "5. Check JAVA_HOME sanity: ${{ steps.test5.outputs.status }}" >> $GITHUB_STEP_SUMMARY