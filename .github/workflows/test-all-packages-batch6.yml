name: Test All Packages (Batch 6) on Arm64

on:
  schedule:
    - cron: '25 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch6.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-garden-runc-release:
    uses: ./.github/workflows/test-garden-runc-release.yml
  
  test-perf:
    uses: ./.github/workflows/test-perf.yml
  
  test-cni:
    uses: ./.github/workflows/test-cni.yml
  
  test-kube-bench:
    uses: ./.github/workflows/test-kube-bench.yml
  
  test-buildkite-elastic-ci-stack-for-aws:
    uses: ./.github/workflows/test-buildkite-elastic-ci-stack-for-aws.yml
  
  test-xxhash:
    uses: ./.github/workflows/test-xxhash.yml
  
  test-suse:
    uses: ./.github/workflows/test-suse.yml
  
  test-robox:
    uses: ./.github/workflows/test-robox.yml
  
  test-relion:
    uses: ./.github/workflows/test-relion.yml
  
  test-_index:
    uses: ./.github/workflows/test-_index.yml
  
  test-repeatmasker:
    uses: ./.github/workflows/test-repeatmasker.yml
  
  test-figtree:
    uses: ./.github/workflows/test-figtree.yml
  
  test-janusgraph:
    uses: ./.github/workflows/test-janusgraph.yml
  
  test-fedora:
    uses: ./.github/workflows/test-fedora.yml
  
  test-sqoop:
    uses: ./.github/workflows/test-sqoop.yml
  
  test-timber:
    uses: ./.github/workflows/test-timber.yml
  
  test-rke2:
    uses: ./.github/workflows/test-rke2.yml
  
  test-reveal:
    uses: ./.github/workflows/test-reveal.yml
  
  test-jupyter:
    uses: ./.github/workflows/test-jupyter.yml
  
  test-php-intl:
    uses: ./.github/workflows/test-php-intl.yml
  
  test-libxml2:
    uses: ./.github/workflows/test-libxml2.yml
  
  test-elastic-defend:
    uses: ./.github/workflows/test-elastic-defend.yml
  
  test-hbase:
    uses: ./.github/workflows/test-hbase.yml
  
  test-prometheus:
    uses: ./.github/workflows/test-prometheus.yml
  
  test-kubernetes:
    uses: ./.github/workflows/test-kubernetes.yml
  
  test-hdfs:
    uses: ./.github/workflows/test-hdfs.yml
  
  test-flume:
    uses: ./.github/workflows/test-flume.yml
  
  test-emissary-ingress:
    uses: ./.github/workflows/test-emissary-ingress.yml
  
  test-expat:
    uses: ./.github/workflows/test-expat.yml
  
  test-sennajs:
    uses: ./.github/workflows/test-sennajs.yml
  
  test-impala:
    uses: ./.github/workflows/test-impala.yml
  
  test-libhelium:
    uses: ./.github/workflows/test-libhelium.yml
  
  test-backstage:
    uses: ./.github/workflows/test-backstage.yml
  
  test-tinyxml:
    uses: ./.github/workflows/test-tinyxml.yml
  
  test-opensearch-cli:
    uses: ./.github/workflows/test-opensearch-cli.yml
  
  test-font-awesome:
    uses: ./.github/workflows/test-font-awesome.yml
  
  test-bamtools:
    uses: ./.github/workflows/test-bamtools.yml
  
  test-wave:
    uses: ./.github/workflows/test-wave.yml
  
  test-apache_tomcat:
    uses: ./.github/workflows/test-apache_tomcat.yml
  
  test-keda:
    uses: ./.github/workflows/test-keda.yml
  
  test-hazelcast:
    uses: ./.github/workflows/test-hazelcast.yml
  
  test-exechealthz:
    uses: ./.github/workflows/test-exechealthz.yml
  
  test-cf-cli:
    uses: ./.github/workflows/test-cf-cli.yml
  
  test-elastic-fleet-server:
    uses: ./.github/workflows/test-elastic-fleet-server.yml
  
  test-canu:
    uses: ./.github/workflows/test-canu.yml
  
  test-ganglia:
    uses: ./.github/workflows/test-ganglia.yml
  
  test-dgraph-labs:
    uses: ./.github/workflows/test-dgraph-labs.yml
  
  test-spring-cloud-gateway:
    uses: ./.github/workflows/test-spring-cloud-gateway.yml
  

  summary:
    needs:
      [
        test-garden-runc-release,
        test-perf,
        test-cni,
        test-kube-bench,
        test-buildkite-elastic-ci-stack-for-aws,
        test-xxhash,
        test-suse,
        test-robox,
        test-relion,
        test-_index,
        test-repeatmasker,
        test-figtree,
        test-janusgraph,
        test-fedora,
        test-sqoop,
        test-timber,
        test-rke2,
        test-reveal,
        test-jupyter,
        test-php-intl,
        test-libxml2,
        test-elastic-defend,
        test-hbase,
        test-prometheus,
        test-kubernetes,
        test-hdfs,
        test-flume,
        test-emissary-ingress,
        test-expat,
        test-sennajs,
        test-impala,
        test-libhelium,
        test-backstage,
        test-tinyxml,
        test-opensearch-cli,
        test-font-awesome,
        test-bamtools,
        test-wave,
        test-apache_tomcat,
        test-keda,
        test-hazelcast,
        test-exechealthz,
        test-cf-cli,
        test-elastic-fleet-server,
        test-canu,
        test-ganglia,
        test-dgraph-labs,
        test-spring-cloud-gateway
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 6)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 6)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
