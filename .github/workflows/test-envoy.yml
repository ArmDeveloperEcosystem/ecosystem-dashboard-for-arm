name: Test Envoy on ARM64

# This workflow can be run independently or called by test-all-packages.yml
on:
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/envoy.md'
      - '.github/workflows/test-envoy.yml'
  workflow_call:  # Allow being called by parent workflow

jobs:
  test-envoy:
    uses: ./.github/workflows/reusable-package-test.yml
    with:
      package_name: "Envoy"
      package_slug: "envoy"
      package_category: "Proxy"
      package_language: "c++"
      install_commands: |
        [
          "sudo apt-get update",
          "sudo apt-get install -y curl gnupg2 ca-certificates lsb-release wget",
          "wget -q https://github.com/envoyproxy/envoy/releases/download/v1.28.0/envoy-1.28.0-linux-aarch64 -O /tmp/envoy",
          "sudo mv /tmp/envoy /usr/local/bin/envoy",
          "sudo chmod +x /usr/local/bin/envoy"
        ]
      version_command: "envoy --version 2>&1 | head -1 | grep -oP '[0-9]+\\.[0-9]+\\.[0-9]+' || echo 'unknown'"
      test_commands: |
        [
          {
            "name": "Check envoy binary",
            "command": "command -v envoy"
          },
          {
            "name": "Check envoy version output",
            "command": "envoy --version"
          },
          {
            "name": "Validate envoy help",
            "command": "envoy --help | grep -q 'USAGE'"
          },
          {
            "name": "Check envoy config validation",
            "command": "echo 'admin: { address: { socket_address: { address: 127.0.0.1, port_value: 9901 } } }' > /tmp/envoy-test.yaml && envoy --mode validate -c /tmp/envoy-test.yaml"
          }
        ]
