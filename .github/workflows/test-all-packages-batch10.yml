name: Test All Packages (Batch 10) on Arm64

on:
  schedule:
    - cron: '45 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch10.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-kubewarden-controller:
    uses: ./.github/workflows/test-kubewarden-controller.yml
  
  test-firecraker:
    uses: ./.github/workflows/test-firecraker.yml
  
  test-spring-framework:
    uses: ./.github/workflows/test-spring-framework.yml
  
  test-kangas:
    uses: ./.github/workflows/test-kangas.yml
  
  test-googletest:
    uses: ./.github/workflows/test-googletest.yml
  
  test-harness:
    uses: ./.github/workflows/test-harness.yml
  
  test-dragonflydb:
    uses: ./.github/workflows/test-dragonflydb.yml
  
  test-indigo-epam:
    uses: ./.github/workflows/test-Indigo-EPAM.yml
  
  test-django:
    uses: ./.github/workflows/test-django.yml
  
  test-shiny:
    uses: ./.github/workflows/test-shiny.yml
  
  test-gzip:
    uses: ./.github/workflows/test-gzip.yml
  
  test-tej_api:
    uses: ./.github/workflows/test-tej_api.yml
  
  test-metricbeat:
    uses: ./.github/workflows/test-metricbeat.yml
  
  test-opentelemetry-python:
    uses: ./.github/workflows/test-opentelemetry-python.yml
  
  test-supervisor:
    uses: ./.github/workflows/test-supervisor.yml
  
  test-macs2:
    uses: ./.github/workflows/test-macs2.yml
  
  test-clearml-open-source:
    uses: ./.github/workflows/test-clearml-open-source.yml
  
  test-xalan:
    uses: ./.github/workflows/test-xalan.yml
  
  test-epinio:
    uses: ./.github/workflows/test-epinio.yml
  
  test-mattermost:
    uses: ./.github/workflows/test-mattermost.yml
  
  test-hugo:
    uses: ./.github/workflows/test-hugo.yml
  
  test-fmt:
    uses: ./.github/workflows/test-fmt.yml
  
  test-openkruise:
    uses: ./.github/workflows/test-openkruise.yml
  
  test-pgbackrest:
    uses: ./.github/workflows/test-pgbackrest.yml
  
  test-spdk:
    uses: ./.github/workflows/test-spdk.yml
  
  test-uyuni:
    uses: ./.github/workflows/test-uyuni.yml
  
  test-sysbench:
    uses: ./.github/workflows/test-sysbench.yml
  
  test-freesurfer:
    uses: ./.github/workflows/test-freeSurfer.yml
  
  test-leveldb:
    uses: ./.github/workflows/test-leveldb.yml
  
  test-cloudflare:
    uses: ./.github/workflows/test-cloudflare.yml
  
  test-hyperscan:
    uses: ./.github/workflows/test-hyperscan.yml
  
  test-plink:
    uses: ./.github/workflows/test-plink.yml
  
  test-valkey:
    uses: ./.github/workflows/test-valkey.yml
  
  test-telegraf:
    uses: ./.github/workflows/test-telegraf.yml
  
  test-python_swat:
    uses: ./.github/workflows/test-python_swat.yml
  
  test-checkov:
    uses: ./.github/workflows/test-checkov.yml
  
  test-raxml:
    uses: ./.github/workflows/test-raxml.yml
  
  test-openembedded:
    uses: ./.github/workflows/test-openembedded.yml
  
  test-flatbuffers:
    uses: ./.github/workflows/test-flatBuffers.yml
  
  test-orionsdk-python:
    uses: ./.github/workflows/test-orionsdk-python.yml
  
  test-rust:
    uses: ./.github/workflows/test-rust.yml
  
  test-buildkite-cli:
    uses: ./.github/workflows/test-buildkite-cli.yml
  
  test-dynatrace:
    uses: ./.github/workflows/test-dynatrace.yml
  
  test-lxd:
    uses: ./.github/workflows/test-lxd.yml
  
  test-php-soap:
    uses: ./.github/workflows/test-php-soap.yml
  
  test-bk_cmdb:
    uses: ./.github/workflows/test-bk_cmdb.yml
  
  test-spring_cloud_config:
    uses: ./.github/workflows/test-spring_cloud_config.yml
  
  test-moosefs:
    uses: ./.github/workflows/test-moosefs.yml
  

  summary:
    needs:
      [
        test-kubewarden-controller,
        test-firecraker,
        test-spring-framework,
        test-kangas,
        test-googletest,
        test-harness,
        test-dragonflydb,
        test-indigo-epam,
        test-django,
        test-shiny,
        test-gzip,
        test-tej_api,
        test-metricbeat,
        test-opentelemetry-python,
        test-supervisor,
        test-macs2,
        test-clearml-open-source,
        test-xalan,
        test-epinio,
        test-mattermost,
        test-hugo,
        test-fmt,
        test-openkruise,
        test-pgbackrest,
        test-spdk,
        test-uyuni,
        test-sysbench,
        test-freesurfer,
        test-leveldb,
        test-cloudflare,
        test-hyperscan,
        test-plink,
        test-valkey,
        test-telegraf,
        test-python_swat,
        test-checkov,
        test-raxml,
        test-openembedded,
        test-flatbuffers,
        test-orionsdk-python,
        test-rust,
        test-buildkite-cli,
        test-dynatrace,
        test-lxd,
        test-php-soap,
        test-bk_cmdb,
        test-spring_cloud_config,
        test-moosefs
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 10)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 10)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

