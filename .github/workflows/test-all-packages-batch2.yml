name: Test All Packages (Batch 2) on Arm64

on:
  # Run nightly at 2:05 AM UTC (5 minutes after Batch 1)
  schedule:
    - cron: '5 2 * * *'

  # Allow manual triggering
  workflow_dispatch:

  # Run on push to main/smoke_tests for testing
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch2.yml'
      - '.github/workflows/test-*.yml'

jobs:
  # ArangoDB
  test-arangodb:
    uses: ./.github/workflows/test-arangodb.yml

  # Archiconda3
  test-archiconda3:
    uses: ./.github/workflows/test-archiconda3.yml

  # Argo
  test-argo:
    uses: ./.github/workflows/test-argo.yml

  # Arthas
  test-arthas:
    uses: ./.github/workflows/test-arthas.yml

  # ASP.NET
  test-aspnet:
    uses: ./.github/workflows/test-aspnet.yml

  # Auditbeat
  test-auditbeat:
    uses: ./.github/workflows/test-auditbeat.yml

  # Authzed/SpiceDB
  test-authzed-spicedb:
    uses: ./.github/workflows/test-authzed-spicedb.yml

  # Avahi
  test-avahi:
    uses: ./.github/workflows/test-avahi.yml

  # Avro
  test-avro:
    uses: ./.github/workflows/test-avro.yml

  # AvxToNeon
  test-avxtoneon:
    uses: ./.github/workflows/test-avxtoneon.yml
  
  # Apache HttpComponents Client
  test-httpcomponents-client:
    uses: ./.github/workflows/test-httpcomponents-client.yml
  
  # Apache Velocity
  test-velocity:
    uses: ./.github/workflows/test-velocity.yml

  # Summary for batch 2
  summary:
    needs:
      [
        test-arangodb,
        test-archiconda3,
        test-argo,
        test-arthas,
        test-aspnet,
        test-auditbeat,
        test-authzed-spicedb,
        test-avahi,
        test-avro,
        test-avxtoneon,
        test-httpcomponents-client,
        test-velocity
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Create summary
        run: |
          echo "# ðŸ“Š Package Test Summary (Batch 2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "âœ… **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "âŒ **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 2)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES âŒ" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (Feature Branch Workaround)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering global summary workflow..."
          gh workflow run test-all-packages-summary.yml --ref ${{ github.ref_name }} --repo ${{ github.repository }}