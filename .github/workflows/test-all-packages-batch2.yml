name: Test All Packages (Batch 2) on Arm64

on:
  workflow_dispatch:
  workflow_call:
jobs:
  test-arangodb:
    uses: ./.github/workflows/test-arangodb.yml
  
  test-archiconda3:
    uses: ./.github/workflows/test-archiconda3.yml
  
  test-argo:
    uses: ./.github/workflows/test-argo.yml
  
  test-arthas:
    uses: ./.github/workflows/test-arthas.yml
  
  test-aspnet:
    uses: ./.github/workflows/test-asp-net.yml
  
  test-auditbeat:
    uses: ./.github/workflows/test-auditbeat.yml
  
  test-authzed-spicedb:
    uses: ./.github/workflows/test-spicedb.yml
  
  test-avahi:
    uses: ./.github/workflows/test-avahi.yml
  
  test-avro:
    uses: ./.github/workflows/test-avro_py.yml
  
  test-avxtoneon:
    uses: ./.github/workflows/test-AvxToNeon.yml
  
  test-httpcomponents-client:
    uses: ./.github/workflows/test-httpcomponents-client.yml
  
  test-velocity:
    uses: ./.github/workflows/test-velocity.yml
  
  test-tinker:
    uses: ./.github/workflows/test-tinker.yml
  
  test-ubuntu:
    uses: ./.github/workflows/test-ubuntu.yml
  
  test-sqlite:
    uses: ./.github/workflows/test-sqlite.yml
  
  test-rqlite:
    uses: ./.github/workflows/test-rqlite.yml
  
  test-keras:
    uses: ./.github/workflows/test-keras.yml
  
  test-pcre:
    uses: ./.github/workflows/test-pcre.yml

  test-robot-framework:
    uses: ./.github/workflows/test-robot-framework.yml
  
  test-netty:
    uses: ./.github/workflows/test-netty.yml
  
  test-haproxy:
    uses: ./.github/workflows/test-haproxy.yml
  
  test-bcrypt:
    uses: ./.github/workflows/test-bcrypt.yml
  
  test-powershell:
    uses: ./.github/workflows/test-powershell.yml
  
  test-spark-sql-kinesis:
    uses: ./.github/workflows/test-spark-sql-kinesis.yml
  
  test-centos:
    uses: ./.github/workflows/test-centos.yml
  
  test-daytona:
    uses: ./.github/workflows/test-daytona.yml

  test-spring-cloud-sleuth:
    uses: ./.github/workflows/test-spring-cloud-sleuth.yml
  
  test-madoguchi:
    uses: ./.github/workflows/test-madoguchi.yml
  
  test-gardener:
    uses: ./.github/workflows/test-gardener.yml
  
  test-tbb:
    uses: ./.github/workflows/test-tbb.yml
  
  test-pinot:
    uses: ./.github/workflows/test-pinot.yml
  
  test-clickhouse:
    uses: ./.github/workflows/test-clickhouse.yml
  
  test-nextflow:
    uses: ./.github/workflows/test-nextflow.yml
  
  test-python-xmlsec:
    uses: ./.github/workflows/test-python-xmlsec.yml
  
  test-5g-ral:
    uses: ./.github/workflows/test-5G-RAL.yml
  
  test-libunwind:
    uses: ./.github/workflows/test-libunwind.yml
  
  test-libaom:
    uses: ./.github/workflows/test-libaom.yml
  
  test-volcano:
    uses: ./.github/workflows/test-volcano.yml
  
  test-katsu:
    uses: ./.github/workflows/test-katsu.yml
  
  test-repeatafterme:
    uses: ./.github/workflows/test-repeatafterme.yml
  
  test-dhcp:
    uses: ./.github/workflows/test-dhcp.yml
  
  test-cloud-hypervisor:
    uses: ./.github/workflows/test-cloud-hypervisor.yml
  
  test-nova:
    uses: ./.github/workflows/test-nova.yml
  
  test-onnx:
    uses: ./.github/workflows/test-onnx.yml
  
  test-geos:
    uses: ./.github/workflows/test-geos.yml

  summary:
    needs:
      [
        test-arangodb,
        test-archiconda3,
        test-argo,
        test-arthas,
        test-aspnet,
        test-auditbeat,
        test-authzed-spicedb,
        test-avahi,
        test-avro,
        test-avxtoneon,
        test-httpcomponents-client,
        test-velocity,
        test-tinker,
        test-ubuntu,
        test-sqlite,
        test-rqlite,
        test-keras,
        test-pcre,
        test-robot-framework,
        test-netty,
        test-haproxy,
        test-bcrypt,
        test-powershell,
        test-spark-sql-kinesis,
        test-centos,
        test-daytona,
        test-spring-cloud-sleuth,
        test-madoguchi,
        test-gardener,
        test-tbb,
        test-pinot,
        test-clickhouse,
        test-nextflow,
        test-python-xmlsec,
        test-5g-ral,
        test-libunwind,
        test-libaom,
        test-volcano,
        test-katsu,
        test-repeatafterme,
        test-dhcp,
        test-cloud-hypervisor,
        test-nova,
        test-onnx,
        test-geos
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# ðŸ“Š Package Test Summary (Batch 2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "âœ… **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "âŒ **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 2)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES âŒ" >> $GITHUB_STEP_SUMMARY

