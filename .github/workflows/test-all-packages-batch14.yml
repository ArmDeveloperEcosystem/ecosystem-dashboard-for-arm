name: Test All Packages (Batch 14) on Arm64

on:
  schedule:
    - cron: '5 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch14.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-musl:
    uses: ./.github/workflows/test-musl.yml
  
  test-igniteui:
    uses: ./.github/workflows/test-igniteui.yml
  
  test-guacamole:
    uses: ./.github/workflows/test-guacamole.yml
  
  test-qt:
    uses: ./.github/workflows/test-qt.yml
  
  test-sentry-go:
    uses: ./.github/workflows/test-sentry-go.yml
  
  test-linkerd:
    uses: ./.github/workflows/test-linkerd.yml
  
  test-avro_py:
    uses: ./.github/workflows/test-avro_py.yml
  
  test-jenkins:
    uses: ./.github/workflows/test-jenkins.yml
  
  test-pgrouting:
    uses: ./.github/workflows/test-pgrouting.yml
  
  test-alpine_linux:
    uses: ./.github/workflows/test-alpine_linux.yml
  
  test-log4cplus:
    uses: ./.github/workflows/test-log4cplus.yml
  
  test-localstack:
    uses: ./.github/workflows/test-localstack.yml
  
  test-harvester:
    uses: ./.github/workflows/test-harvester.yml
  
  test-lzip:
    uses: ./.github/workflows/test-lzip.yml
  
  test-influxdb:
    uses: ./.github/workflows/test-influxdb.yml
  
  test-git:
    uses: ./.github/workflows/test-git.yml
  
  test-apache_kudu:
    uses: ./.github/workflows/test-apache_kudu.yml
  
  test-zabbix:
    uses: ./.github/workflows/test-zabbix.yml
  
  test-openzfs:
    uses: ./.github/workflows/test-openzfs.yml
  
  test-maas:
    uses: ./.github/workflows/test-maas.yml
  
  test-xxljob:
    uses: ./.github/workflows/test-xxljob.yml
  
  test-nettle:
    uses: ./.github/workflows/test-nettle.yml
  
  test-keystone:
    uses: ./.github/workflows/test-keystone.yml
  
  test-open-policy-agent:
    uses: ./.github/workflows/test-open-policy-agent.yml
  
  test-maven:
    uses: ./.github/workflows/test-maven.yml
  
  test-gitlab:
    uses: ./.github/workflows/test-gitlab.yml
  
  test-puppet:
    uses: ./.github/workflows/test-puppet.yml
  
  test-beeGFS:
    uses: ./.github/workflows/test-beeGFS.yml
  
  test-ranger:
    uses: ./.github/workflows/test-ranger.yml
  
  test-pachyderm:
    uses: ./.github/workflows/test-pachyderm.yml
  
  test-apache-doris:
    uses: ./.github/workflows/test-apache-doris.yml
  
  test-infracost:
    uses: ./.github/workflows/test-infracost.yml
  
  test-hugo-extended:
    uses: ./.github/workflows/test-hugo-extended.yml
  
  test-knative:
    uses: ./.github/workflows/test-knative.yml
  
  test-notary:
    uses: ./.github/workflows/test-notary.yml
  
  test-sysget:
    uses: ./.github/workflows/test-sysget.yml
  
  test-wordpress:
    uses: ./.github/workflows/test-wordpress.yml
  
  test-cortex:
    uses: ./.github/workflows/test-cortex.yml
  
  test-zerotier:
    uses: ./.github/workflows/test-zerotier.yml
  
  test-crystal-language:
    uses: ./.github/workflows/test-crystal-language.yml
  
  test-celery:
    uses: ./.github/workflows/test-celery.yml
  
  test-thanos:
    uses: ./.github/workflows/test-thanos.yml
  
  test-proj:
    uses: ./.github/workflows/test-proj.yml
  
  test-hyperledger-besu:
    uses: ./.github/workflows/test-hyperledger-besu.yml
  
  test-libev:
    uses: ./.github/workflows/test-libev.yml
  
  test-pkg-config:
    uses: ./.github/workflows/test-pkg-config.yml
  
  test-distribution-registry:
    uses: ./.github/workflows/test-distribution-registry.yml
  
  test-mlrun:
    uses: ./.github/workflows/test-mlrun.yml
  

  summary:
    needs:
      [
        test-musl,
        test-igniteui,
        test-guacamole,
        test-qt,
        test-sentry-go,
        test-linkerd,
        test-avro_py,
        test-jenkins,
        test-pgrouting,
        test-alpine_linux,
        test-log4cplus,
        test-localstack,
        test-harvester,
        test-lzip,
        test-influxdb,
        test-git,
        test-apache_kudu,
        test-zabbix,
        test-openzfs,
        test-maas,
        test-xxljob,
        test-nettle,
        test-keystone,
        test-open-policy-agent,
        test-maven,
        test-gitlab,
        test-puppet,
        test-beeGFS,
        test-ranger,
        test-pachyderm,
        test-apache-doris,
        test-infracost,
        test-hugo-extended,
        test-knative,
        test-notary,
        test-sysget,
        test-wordpress,
        test-cortex,
        test-zerotier,
        test-crystal-language,
        test-celery,
        test-thanos,
        test-proj,
        test-hyperledger-besu,
        test-libev,
        test-pkg-config,
        test-distribution-registry,
        test-mlrun
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 14)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 14)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
