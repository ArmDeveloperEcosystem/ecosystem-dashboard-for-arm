name: Nightly All Packages + Global Summary (Arm64)

on:
  # Single scheduled entrypoint that runs EVERYTHING
  schedule:
    - cron: '0 2 * * *'

  # Also run orchestrator when code or JSON changes
  push:
    branches: [ main, smoke_tests ]
    paths:
      - 'content/opensource_packages/*.md'
      - 'content/commercial_packages/*.md'
      - 'data/test-results/*.json'
      - '.github/workflows/test-all-packages-batch1.yml'
      - '.github/workflows/test-all-packages-batch2.yml'
      - '.github/workflows/test-all-packages-summary.yml'

  # Manual trigger
  workflow_dispatch:

jobs:
  # -------- BATCH 1 ----------
  batch1:
    name: Run Batch 1
    uses: ./.github/workflows/test-all-packages-batch1.yml

  # -------- BATCH 2 ----------
  batch2:
    name: Run Batch 2
    uses: ./.github/workflows/test-all-packages-batch2.yml

  # -------- GLOBAL SUMMARY ---------
  global-summary:
    name: Global Summary after ALL batches
    needs: [batch1, batch2]
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Pull latest JSON from batch commits
        run: |
          git pull origin "${{ github.ref_name }}" || true

      - name: Build local test-results structure
        run: |
          mkdir -p test-results
          for f in data/test-results/*.json; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .json)
            mkdir -p "test-results/${base}-test-results"
            cp "$f" "test-results/${base}-test-results/${base}.json"
          done

      - name: Create big global summary
        run: |
          echo "# ðŸ“Š GLOBAL PACKAGE TEST SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL=0
          PASS=0
          FAIL=0

          for d in test-results/*/; do
            for j in "$d"/*.json; do
              [ -f "$j" ] || continue

              TOTAL=$((TOTAL+1))
              NAME=$(jq -r '.package.name' "$j")
              VERSION=$(jq -r '.package.version' "$j")
              STATUS=$(jq -r '.run.status' "$j")
              PASSED=$(jq -r '.tests.passed' "$j")
              FAILED=$(jq -r '.tests.failed' "$j")

              if [ "$STATUS" = "success" ]; then
                PASS=$((PASS+1))
                echo "âœ… **$NAME** (v$VERSION): $PASSED tests passed" >> $GITHUB_STEP_SUMMARY
              else
                FAIL=$((FAIL+1))
                echo "âŒ **$NAME** (v$VERSION): $FAILED tests failed" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## OVERALL" >> $GITHUB_STEP_SUMMARY
          echo "- Total Packages: **$TOTAL**" >> $GITHUB_STEP_SUMMARY
          echo "- Passed: **$PASS** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: **$FAIL** âŒ" >> $GITHUB_STEP_SUMMARY