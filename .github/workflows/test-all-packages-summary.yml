name: Nightly All Packages + Global Summary (Arm64)

on:
  # Single scheduled trigger to run EVERYTHING
  schedule:
    - cron: '0 2 * * *'  # 02:00 UTC

  # Optional: also run orchestrator on push
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - 'content/commercial_packages/*.md'
      - 'data/test-results/*.json'
      - '.github/workflows/test-all-packages-batch1.yml'
      - '.github/workflows/test-all-packages-batch2.yml'
      - '.github/workflows/test-all-packages-orchestrator.yml'

  # Manual trigger from Actions UI
  workflow_dispatch:

jobs:
  # 1) Run Batch 1 as a reusable workflow
  batch1:
    uses: ./.github/workflows/test-all-packages-batch1.yml

  # 2) Run Batch 2 as a reusable workflow
  batch2:
    uses: ./.github/workflows/test-all-packages-batch2.yml

  # 3) Global summary â€“ runs ONLY after batch1 & batch2 finish
  summary:
    needs: [batch1, batch2]
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare test-results structure from data/test-results
        run: |
          mkdir -p test-results
          # Recreate artifact-like layout: test-results/<name>/<name>.json
          for f in data/test-results/*.json; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .json)
            mkdir -p "test-results/${base}-test-results"
            cp "$f" "test-results/${base}-test-results/${base}.json"
          done

      - name: Create global summary
        run: |
          echo "# ðŸ“Š Package Test Summary (All Batches)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "âœ… **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "âŒ **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (All Batches)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES âŒ" >> $GITHUB_STEP_SUMMARY