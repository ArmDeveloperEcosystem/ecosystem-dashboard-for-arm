name: Global Test Summary (All Batches)

on:
  # Auto-trigger after BOTH batches complete
  workflow_run:
    workflows:
      - "Test All Packages (Batch 1) on Arm64"
      - "Test All Packages (Batch 2) on Arm64"
    types:
      - completed

  # Run on push to main/smoke_tests for testing
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - '.github/workflows/test-all-packages-summary.yml'

  # Manual trigger for ad-hoc summaries
  workflow_dispatch:

jobs:
  global-summary:
    name: Generate Global Summary
    runs-on: ubuntu-24.04-arm
    # Run even if batches fail
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use the branch that triggered the workflow_run
          ref: ${{ github.event.workflow_run.head_branch || github.ref_name }}

      - name: Pull latest test results from repo
        run: |
          echo "Pulling latest commits with test results..."
          git pull origin "${{ github.event.workflow_run.head_branch || github.ref_name }}" || true

      - name: Build test-results structure from committed JSON
        run: |
          mkdir -p test-results
          
          # Recreate artifact-like structure for compatibility
          for f in data/test-results/*.json; do
            [ -f "$f" ] || continue
            base=$(basename "$f" .json)
            mkdir -p "test-results/${base}-test-results"
            cp "$f" "test-results/${base}-test-results/${base}.json"
          done
          
          echo "âœ… Prepared $(find test-results -name '*.json' | wc -l) test result files"

      - name: Generate global summary
        run: |
          echo "# ðŸ“Š Global Package Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Last updated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL=0
          PASS=0
          FAIL=0

          # Process all JSON files
          for result_dir in test-results/*/; do
            for json_file in "$result_dir"*.json; do
              [ -f "$json_file" ] || continue

              TOTAL=$((TOTAL + 1))
              
              NAME=$(jq -r '.package.name' "$json_file")
              VERSION=$(jq -r '.package.version' "$json_file")
              STATUS=$(jq -r '.run.status' "$json_file")
              PASSED=$(jq -r '.tests.passed' "$json_file")
              FAILED=$(jq -r '.tests.failed' "$json_file")

              if [ "$STATUS" = "success" ]; then
                PASS=$((PASS + 1))
                echo "âœ… **$NAME** (v$VERSION): $PASSED tests passed" >> $GITHUB_STEP_SUMMARY
              else
                FAIL=$((FAIL + 1))
                echo "âŒ **$NAME** (v$VERSION): $FAILED tests failed" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASS âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAIL âŒ" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning:** No test results found. Batches may still be running." >> $GITHUB_STEP_SUMMARY
          fi