name: Test All Packages (Batch 12) on Arm64

on:
  schedule:
    - cron: '55 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch12.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-dav1d:
    uses: ./.github/workflows/test-dav1d.yml
  
  test-nacos:
    uses: ./.github/workflows/test-nacos.yml
  
  test-qperf:
    uses: ./.github/workflows/test-qperf.yml
  
  test-gdb:
    uses: ./.github/workflows/test-gdb.yml
  
  test-imagemagick:
    uses: ./.github/workflows/test-imagemagick.yml
  
  test-seastar:
    uses: ./.github/workflows/test-seastar.yml
  
  test-xen_ci:
    uses: ./.github/workflows/test-xen_ci.yml
  
  test-kobert:
    uses: ./.github/workflows/test-kobert.yml
  
  test-presto:
    uses: ./.github/workflows/test-presto.yml
  
  test-caddy:
    uses: ./.github/workflows/test-caddy.yml
  
  test-lzo:
    uses: ./.github/workflows/test-lzo.yml
  
  test-crossplane:
    uses: ./.github/workflows/test-crossplane.yml
  
  test-tikv:
    uses: ./.github/workflows/test-tikv.yml
  
  test-nomad-open-source:
    uses: ./.github/workflows/test-nomad-open-source.yml
  
  test-freedesktop-sdk:
    uses: ./.github/workflows/test-freedesktop-sdk.yml
  
  test-kyuubi:
    uses: ./.github/workflows/test-kyuubi.yml
  
  test-hmmer:
    uses: ./.github/workflows/test-hmmer.yml
  
  test-trf:
    uses: ./.github/workflows/test-trf.yml
  
  test-grpc-java:
    uses: ./.github/workflows/test-grpc-java.yml
  
  test-rocketmq:
    uses: ./.github/workflows/test-rocketmq.yml
  
  test-hadoop:
    uses: ./.github/workflows/test-hadoop.yml
  
  test-cubefs:
    uses: ./.github/workflows/test-cubefs.yml
  
  test-vscode:
    uses: ./.github/workflows/test-vscode.yml
  
  test-enca:
    uses: ./.github/workflows/test-enca.yml
  
  test-devtron:
    uses: ./.github/workflows/test-devtron.yml
  
  test-helm:
    uses: ./.github/workflows/test-helm.yml
  
  test-flex:
    uses: ./.github/workflows/test-flex.yml
  
  test-py3c:
    uses: ./.github/workflows/test-py3c.yml
  
  test-vitess:
    uses: ./.github/workflows/test-vitess.yml
  
  test-openj9:
    uses: ./.github/workflows/test-openj9.yml
  
  test-mongoose:
    uses: ./.github/workflows/test-mongoose.yml
  
  test-conda:
    uses: ./.github/workflows/test-conda.yml
  
  test-hue:
    uses: ./.github/workflows/test-hue.yml
  
  test-cloudevents-go:
    uses: ./.github/workflows/test-cloudevents-go.yml
  
  test-apbs:
    uses: ./.github/workflows/test-apbs.yml
  
  test-openmetrics:
    uses: ./.github/workflows/test-openmetrics.yml
  
  test-7-zip:
    uses: ./.github/workflows/test-7-zip.yml
  
  test-spring-cloud-function:
    uses: ./.github/workflows/test-spring-cloud-function.yml
  
  test-dolphinscheduler:
    uses: ./.github/workflows/test-dolphinscheduler.yml
  
  test-benchmark:
    uses: ./.github/workflows/test-benchmark.yml
  
  test-spring_boot:
    uses: ./.github/workflows/test-spring_boot.yml
  
  test-k3os:
    uses: ./.github/workflows/test-k3os.yml
  
  test-valgrind:
    uses: ./.github/workflows/test-valgrind.yml
  
  test-lua:
    uses: ./.github/workflows/test-lua.yml
  
  test-elemental-operator:
    uses: ./.github/workflows/test-elemental-operator.yml
  
  test-juju:
    uses: ./.github/workflows/test-juju.yml
  
  test-bcache:
    uses: ./.github/workflows/test-bcache.yml
  
  test-caffe:
    uses: ./.github/workflows/test-caffe.yml
  

  summary:
    needs:
      [
        test-dav1d,
        test-nacos,
        test-qperf,
        test-gdb,
        test-imagemagick,
        test-seastar,
        test-xen_ci,
        test-kobert,
        test-presto,
        test-caddy,
        test-lzo,
        test-crossplane,
        test-tikv,
        test-nomad-open-source,
        test-freedesktop-sdk,
        test-kyuubi,
        test-hmmer,
        test-trf,
        test-grpc-java,
        test-rocketmq,
        test-hadoop,
        test-cubefs,
        test-vscode,
        test-enca,
        test-devtron,
        test-helm,
        test-flex,
        test-py3c,
        test-vitess,
        test-openj9,
        test-mongoose,
        test-conda,
        test-hue,
        test-cloudevents-go,
        test-apbs,
        test-openmetrics,
        test-7-zip,
        test-spring-cloud-function,
        test-dolphinscheduler,
        test-benchmark,
        test-spring_boot,
        test-k3os,
        test-valgrind,
        test-lua,
        test-elemental-operator,
        test-juju,
        test-bcache,
        test-caffe
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 12)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 12)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

