name: Test All Packages (Batch 9) on Arm64

on:
  schedule:
    - cron: '40 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch9.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-new-relic:
    uses: ./.github/workflows/test-new-relic.yml
  
  test-java-openjdk:
    uses: ./.github/workflows/test-java-openjdk.yml
  
  test-kettle:
    uses: ./.github/workflows/test-kettle.yml
  
  test-taskflow:
    uses: ./.github/workflows/test-taskflow.yml
  
  test-catj:
    uses: ./.github/workflows/test-catj.yml
  
  test-brpc:
    uses: ./.github/workflows/test-brpc.yml
  
  test-vasp:
    uses: ./.github/workflows/test-vasp.yml
  
  test-linstor-server:
    uses: ./.github/workflows/test-linstor-server.yml
  
  test-visualreview:
    uses: ./.github/workflows/test-visualreview.yml
  
  test-ms_iis:
    uses: ./.github/workflows/test-ms_iis.yml
  
  test-jax:
    uses: ./.github/workflows/test-jax.yml
  
  test-disconf:
    uses: ./.github/workflows/test-disconf.yml
  
  test-packer:
    uses: ./.github/workflows/test-packer.yml
  
  test-ubuntucore:
    uses: ./.github/workflows/test-ubuntucore.yml
  
  test-opensuse-tumbleweed:
    uses: ./.github/workflows/test-opensuse-tumbleweed.yml
  
  test-flask:
    uses: ./.github/workflows/test-flask.yml
  
  test-glusterfs:
    uses: ./.github/workflows/test-glusterfs.yml
  
  test-kurento:
    uses: ./.github/workflows/test-kurento.yml
  
  test-kubewarden-audit-scanner:
    uses: ./.github/workflows/test-kubewarden-audit-scanner.yml
  
  test-hal:
    uses: ./.github/workflows/test-hal.yml
  
  test-unixbench:
    uses: ./.github/workflows/test-unixbench.yml
  
  test-elastic-agent:
    uses: ./.github/workflows/test-elastic-agent.yml
  
  test-libvirt:
    uses: ./.github/workflows/test-libvirt.yml
  
  test-magento:
    uses: ./.github/workflows/test-magento.yml
  
  test-domo-python-sdk:
    uses: ./.github/workflows/test-domo-python-sdk.yml
  
  test-gradle:
    uses: ./.github/workflows/test-gradle.yml
  
  test-lz4:
    uses: ./.github/workflows/test-lz4.yml
  
  test-cgal:
    uses: ./.github/workflows/test-cgal.yml
  
  test-kubevirt:
    uses: ./.github/workflows/test-kubevirt.yml
  
  test-qiniu-qshell:
    uses: ./.github/workflows/test-qiniu-qshell.yml
  
  test-kubewarden-kwctl:
    uses: ./.github/workflows/test-kubewarden-kwctl.yml
  
  test-xgboost:
    uses: ./.github/workflows/test-xgboost.yml
  
  test-htop:
    uses: ./.github/workflows/test-htop.yml
  
  test-php-gd:
    uses: ./.github/workflows/test-php-gd.yml
  
  test-opensearch-benchmark:
    uses: ./.github/workflows/test-opensearch-benchmark.yml
  
  test-re2:
    uses: ./.github/workflows/test-re2.yml
  
  test-ipfs:
    uses: ./.github/workflows/test-ipfs.yml
  
  test-liquibase:
    uses: ./.github/workflows/test-liquibase.yml
  
  test-golang:
    uses: ./.github/workflows/test-golang.yml
  
  test-pdfgrep:
    uses: ./.github/workflows/test-pdfgrep.yml
  
  test-lsyncd:
    uses: ./.github/workflows/test-lsyncd.yml
  
  test-drbd:
    uses: ./.github/workflows/test-drbd.yml
  
  test-loki:
    uses: ./.github/workflows/test-loki.yml
  
  test-php-mysql:
    uses: ./.github/workflows/test-php-mysql.yml
  
  test-barbican:
    uses: ./.github/workflows/test-barbican.yml
  
  test-ovirt:
    uses: ./.github/workflows/test-ovirt.yml
  
  test-signoz:
    uses: ./.github/workflows/test-signoz.yml
  
  test-php-sqlite3:
    uses: ./.github/workflows/test-php-sqlite3.yml
  

  summary:
    needs:
      [
        test-new-relic,
        test-java-openjdk,
        test-kettle,
        test-taskflow,
        test-catj,
        test-brpc,
        test-vasp,
        test-linstor-server,
        test-visualreview,
        test-ms_iis,
        test-jax,
        test-disconf,
        test-packer,
        test-ubuntucore,
        test-opensuse-tumbleweed,
        test-flask,
        test-glusterfs,
        test-kurento,
        test-kubewarden-audit-scanner,
        test-hal,
        test-unixbench,
        test-elastic-agent,
        test-libvirt,
        test-magento,
        test-domo-python-sdk,
        test-gradle,
        test-lz4,
        test-cgal,
        test-kubevirt,
        test-qiniu-qshell,
        test-kubewarden-kwctl,
        test-xgboost,
        test-htop,
        test-php-gd,
        test-opensearch-benchmark,
        test-re2,
        test-ipfs,
        test-liquibase,
        test-golang,
        test-pdfgrep,
        test-lsyncd,
        test-drbd,
        test-loki,
        test-php-mysql,
        test-barbican,
        test-ovirt,
        test-signoz,
        test-php-sqlite3
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 9)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 9)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

