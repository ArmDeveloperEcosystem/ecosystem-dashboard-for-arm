name: Test All Packages (Batch 3) on Arm64

on:
  schedule:
    - cron: '10 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch3.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-ydata-profiling:
    uses: ./.github/workflows/test-ydata-profiling.yml
  
  test-jmeter:
    uses: ./.github/workflows/test-jmeter.yml
  
  test-spring_cloud_task:
    uses: ./.github/workflows/test-spring_cloud_task.yml
  
  test-cloudevents-python:
    uses: ./.github/workflows/test-cloudevents-python.yml
  
  test-xtrabackup:
    uses: ./.github/workflows/test-xtrabackup.yml
  
  test-mpfr:
    uses: ./.github/workflows/test-mpfr.yml
  
  test-keydb:
    uses: ./.github/workflows/test-keydb.yml
  
  test-tensorflow:
    uses: ./.github/workflows/test-tensorflow.yml
  
  test-pgpool-ii:
    uses: ./.github/workflows/test-pgpool-ii.yml
  
  test-gunicorn:
    uses: ./.github/workflows/test-gunicorn.yml
  
  test-circleci_cli:
    uses: ./.github/workflows/test-circleci_cli.yml
  
  test-groovy_grails:
    uses: ./.github/workflows/test-groovy_grails.yml
  
  test-phan:
    uses: ./.github/workflows/test-phan.yml
  
  test-mongo:
    uses: ./.github/workflows/test-mongo.yml
  
  test-kaezip:
    uses: ./.github/workflows/test-kaezip.yml
  
  test-apache_drill:
    uses: ./.github/workflows/test-apache_drill.yml
  
  test-pinentry-curses:
    uses: ./.github/workflows/test-pinentry-curses.yml
  
  test-tiffin:
    uses: ./.github/workflows/test-tiffin.yml
  
  test-heketi:
    uses: ./.github/workflows/test-heketi.yml
  
  test-hawking:
    uses: ./.github/workflows/test-hawking.yml
  
  test-mongodb-c-driver:
    uses: ./.github/workflows/test-mongodb-c-driver.yml
  
  test-logstash:
    uses: ./.github/workflows/test-logstash.yml
  
  test-calico:
    uses: ./.github/workflows/test-calico.yml
  
  test-openebs:
    uses: ./.github/workflows/test-openebs.yml
  
  test-gmp:
    uses: ./.github/workflows/test-gmp.yml
  
  test-freeimage:
    uses: ./.github/workflows/test-freeimage.yml
  
  test-cobbler:
    uses: ./.github/workflows/test-cobbler.yml
  
  test-php-apcu:
    uses: ./.github/workflows/test-php-apcu.yml
  
  test-cloud-custodian:
    uses: ./.github/workflows/test-cloud-custodian.yml
  
  test-fio:
    uses: ./.github/workflows/test-fio.yml
  
  test-spring_cloud_netflix:
    uses: ./.github/workflows/test-spring_cloud_netflix.yml
  
  test-nats:
    uses: ./.github/workflows/test-nats.yml
  
  test-dragonfly:
    uses: ./.github/workflows/test-dragonfly.yml
  
  test-nodejs:
    uses: ./.github/workflows/test-nodejs.yml
  
  test-apache-shiro:
    uses: ./.github/workflows/test-apache-shiro.yml
  
  test-zlib:
    uses: ./.github/workflows/test-zlib.yml
  
  test-murmurhash:
    uses: ./.github/workflows/test-murmurhash.yml
  
  test-elastic-mockopampserver:
    uses: ./.github/workflows/test-elastic-mockopampserver.yml
  
  test-harness-cli:
    uses: ./.github/workflows/test-harness-cli.yml
  
  test-ovs:
    uses: ./.github/workflows/test-ovs.yml
  
  test-in-toto:
    uses: ./.github/workflows/test-in-toto.yml
  
  test-libuv:
    uses: ./.github/workflows/test-libuv.yml
  
  test-pigz:
    uses: ./.github/workflows/test-pigz.yml
  
  test-miniasm:
    uses: ./.github/workflows/test-miniasm.yml
  
  test-timescaledb:
    uses: ./.github/workflows/test-timescaledb.yml
  
  test-wget:
    uses: ./.github/workflows/test-wget.yml
  
  test-threatmapper:
    uses: ./.github/workflows/test-threatmapper.yml
  
  test-opensearch:
    uses: ./.github/workflows/test-opensearch.yml
  

  summary:
    needs:
      [
        test-ydata-profiling,
        test-jmeter,
        test-spring_cloud_task,
        test-cloudevents-python,
        test-xtrabackup,
        test-mpfr,
        test-keydb,
        test-tensorflow,
        test-pgpool-ii,
        test-gunicorn,
        test-circleci_cli,
        test-groovy_grails,
        test-phan,
        test-mongo,
        test-kaezip,
        test-apache_drill,
        test-pinentry-curses,
        test-tiffin,
        test-heketi,
        test-hawking,
        test-mongodb-c-driver,
        test-logstash,
        test-calico,
        test-openebs,
        test-gmp,
        test-freeimage,
        test-cobbler,
        test-php-apcu,
        test-cloud-custodian,
        test-fio,
        test-spring_cloud_netflix,
        test-nats,
        test-dragonfly,
        test-nodejs,
        test-apache-shiro,
        test-zlib,
        test-murmurhash,
        test-elastic-mockopampserver,
        test-harness-cli,
        test-ovs,
        test-in-toto,
        test-libuv,
        test-pigz,
        test-miniasm,
        test-timescaledb,
        test-wget,
        test-threatmapper,
        test-opensearch
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 3)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 3)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
