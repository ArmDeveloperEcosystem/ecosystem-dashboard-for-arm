name: Test All Packages (Batch 1) on Arm64

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch1.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-nginx:
    uses: ./.github/workflows/test-nginx.yml
  
  test-envoy:
    uses: ./.github/workflows/test-envoy.yml
  
  test-kafka:
    uses: ./.github/workflows/test-kafka.yml
  
  test-memcached:
    uses: ./.github/workflows/test-memcached.yml
  
  test-mongodb:
    uses: ./.github/workflows/test-mongodb.yml
  
  test-mysql:
    uses: ./.github/workflows/test-mysql.yml
  
  test-spark:
    uses: ./.github/workflows/test-spark.yml
  
  test-postgres:
    uses: ./.github/workflows/test-postgres.yml
  
  test-ceph:
    uses: ./.github/workflows/test-ceph.yml
  
  test-cassandra:
    uses: ./.github/workflows/test-cassandra.yml
  
  test-rocksdb:
    uses: ./.github/workflows/test-rocksdb.yml
  
  test-abyss:
    uses: ./.github/workflows/test-abyss.yml
  
  test-accumulo:
    uses: ./.github/workflows/test-accumulo.yml
  
  test-acl:
    uses: ./.github/workflows/test-acl.yml
  
  test-activemq:
    uses: ./.github/workflows/test-activemq.yml
  
  test-adoptopenjdk:
    uses: ./.github/workflows/test-adoptopenjdk.yml
  
  test-aerospike:
    uses: ./.github/workflows/test-aerospike.yml
  
  test-ace:
    uses: ./.github/workflows/test-ace.yml
  
  test-akka:
    uses: ./.github/workflows/test-akka.yml
  
  test-alfresco:
    uses: ./.github/workflows/test-alfresco.yml
  
  test-alluxio:
    uses: ./.github/workflows/test-alluxio.yml
  
  test-almalinux:
    uses: ./.github/workflows/test-almalinux.yml
  
  test-alpinelinux:
    uses: ./.github/workflows/test-alpinelinux.yml
  
  test-anda:
    uses: ./.github/workflows/test-anda.yml
  
  test-cuttlefish:
    uses: ./.github/workflows/test-cuttlefish.yml
  
  test-angularcli:
    uses: ./.github/workflows/test-angularcli.yml
  
  test-apache-ant:
    uses: ./.github/workflows/test-apache-ant.yml
  
  test-apisix:
    uses: ./.github/workflows/test-apisix.yml
  
  test-apache-arrow:
    uses: ./.github/workflows/test-apache-arrow.yml
  
  test-atlas:
    uses: ./.github/workflows/test-atlas.yml
  
  test-couchdb:
    uses: ./.github/workflows/test-couchdb.yml
  
  test-doris:
    uses: ./.github/workflows/test-doris.yml
  
  test-drill:
    uses: ./.github/workflows/test-drill.yml
  
  test-freemarker:
    uses: ./.github/workflows/test-freemarker.yml
  
  test-httpd:
    uses: ./.github/workflows/test-httpd.yml
  
  test-knox:
    uses: ./.github/workflows/test-knox.yml
  
  test-kudu:
    uses: ./.github/workflows/test-kudu.yml
  
  test-nifi:
    uses: ./.github/workflows/test-nifi.yml
  
  test-apr:
    uses: ./.github/workflows/test-apr.yml
  
  test-pulsar:
    uses: ./.github/workflows/test-pulsar.yml
  
  test-anolis-os:
    uses: ./.github/workflows/test-anolis-os.yml
  
  test-ansible:
    uses: ./.github/workflows/test-ansible.yml
  
  test-antlr4:
    uses: ./.github/workflows/test-antlr4.yml
  
  test-airflow:
    uses: ./.github/workflows/test-airflow.yml
  
  test-camel-k:
    uses: ./.github/workflows/test-camel-k.yml
  
  test-shiro:
    uses: ./.github/workflows/test-shiro.yml
  
  test-thrift:
    uses: ./.github/workflows/test-thrift.yml
  
  test-tomcat:
    uses: ./.github/workflows/test-tomcat.yml
  

  summary:
    needs:
      [
        test-nginx,
        test-envoy,
        test-kafka,
        test-memcached,
        test-mongodb,
        test-mysql,
        test-spark,
        test-postgres,
        test-ceph,
        test-cassandra,
        test-rocksdb,
        test-abyss,
        test-accumulo,
        test-acl,
        test-activemq,
        test-adoptopenjdk,
        test-aerospike,
        test-ace,
        test-akka,
        test-alfresco,
        test-alluxio,
        test-almalinux,
        test-alpinelinux,
        test-anda,
        test-cuttlefish,
        test-angularcli,
        test-apache-ant,
        test-apisix,
        test-apache-arrow,
        test-atlas,
        test-couchdb,
        test-doris,
        test-drill,
        test-freemarker,
        test-httpd,
        test-knox,
        test-kudu,
        test-nifi,
        test-apr,
        test-pulsar,
        test-anolis-os,
        test-ansible,
        test-antlr4,
        test-airflow,
        test-camel-k,
        test-shiro,
        test-thrift,
        test-tomcat
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }
