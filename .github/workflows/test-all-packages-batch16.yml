name: Test All Packages (Batch 16) on Arm64

on:
  schedule:
    - cron: '15 3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - smoke_tests
    paths:
      - 'content/opensource_packages/*.md'
      - '.github/workflows/test-all-packages-batch16.yml'
      - '.github/workflows/test-*.yml'

jobs:
  test-tesseract:
    uses: ./.github/workflows/test-tesseract.yml
  
  test-salmon:
    uses: ./.github/workflows/test-salmon.yml

  test-opensearch-dashboard:
    uses: ./.github/workflows/test-opensearch-dashboard.yml
  
  test-packetbeat:
    uses: ./.github/workflows/test-packetbeat.yml

  test-openvvc:
    uses: ./.github/workflows/test-openvvc.yml
  
  test-liferay:
    uses: ./.github/workflows/test-liferay.yml
  
  test-elastic-crawler:
    uses: ./.github/workflows/test-elastic-crawler.yml
  
  test-typescript:
    uses: ./.github/workflows/test-typescript.yml

  test-roaringbitmap:
    uses: ./.github/workflows/test-RoaringBitmap.yml
  
  test-falco:
    uses: ./.github/workflows/test-falco.yml
  
  test-haskell-nix:
    uses: ./.github/workflows/test-haskell-nix.yml
  
  test-flannel:
    uses: ./.github/workflows/test-flannel.yml
  
  test-redis:
    uses: ./.github/workflows/test-redis.yml
  
  test-docker:
    uses: ./.github/workflows/test-docker.yml

  test-openshift:
    uses: ./.github/workflows/test-openshift.yml
  
  test-rundeck:
    uses: ./.github/workflows/test-rundeck.yml

  test-kubewarden-policy-server:
    uses: ./.github/workflows/test-kubewarden-policy-server.yml
  
  test-memtester:
    uses: ./.github/workflows/test-memtester.yml
  
  test-lxcfs:
    uses: ./.github/workflows/test-lxcfs.yml
  
  test-npm:
    uses: ./.github/workflows/test-npm.yml
  
  test-terraform:
    uses: ./.github/workflows/test-terraform.yml
  
  test-postman:
    uses: ./.github/workflows/test-postman.yml
  
  test-iotop:
    uses: ./.github/workflows/test-iotop.yml
  
  test-openscenegraph:
    uses: ./.github/workflows/test-openscenegraph.yml
  
  test-pandas:
    uses: ./.github/workflows/test-pandas.yml
  
  test-geoserver:
    uses: ./.github/workflows/test-geoserver.yml
  
  test-kata:
    uses: ./.github/workflows/test-kata.yml
  
  test-netcdf:
    uses: ./.github/workflows/test-netcdf.yml
  
  test-cjson:
    uses: ./.github/workflows/test-cjson.yml
  
  test-domo-node-sdk:
    uses: ./.github/workflows/test-domo-node-sdk.yml

  test-swig:
    uses: ./.github/workflows/test-swig.yml
  
  test-tcl:
    uses: ./.github/workflows/test-tcl.yml
  
  test-zstandard:
    uses: ./.github/workflows/test-zstandard.yml
  
  test-functionbeat:
    uses: ./.github/workflows/test-functionbeat.yml
  
  test-cilium:
    uses: ./.github/workflows/test-cilium.yml
  
  test-eclipse_temurin:
    uses: ./.github/workflows/test-eclipse_temurin.yml
  
  test-vvenc:
    uses: ./.github/workflows/test-VVenC.yml
  
  test-elasticapmserver:
    uses: ./.github/workflows/test-elasticapmserver.yml
  
  test-dapr:
    uses: ./.github/workflows/test-dapr.yml
  
  test-openssh:
    uses: ./.github/workflows/test-openssh.yml
  
  test-gperftools:
    uses: ./.github/workflows/test-gperftools.yml
  
  test-haystack:
    uses: ./.github/workflows/test-haystack.yml

  summary:
    needs:
      [
        test-tesseract,
        test-salmon,
        test-jsonnet,
        test-opensearch-dashboard,
        test-packetbeat,
        test-speedseq,
        test-openvvc,
        test-liferay,
        test-elastic-crawler,
        test-typescript,
        test-inspec,
        test-roaringbitmap,
        test-falco,
        test-haskell-nix,
        test-flannel,
        test-redis,
        test-docker,
        test-p7zip,
        test-openshift,
        test-rundeck,
        test-iceberg,
        test-kubewarden-policy-server,
        test-memtester,
        test-lxcfs,
        test-npm,
        test-terraform,
        test-postman,
        test-iotop,
        test-openscenegraph,
        test-pandas,
        test-geoserver,
        test-kata,
        test-netcdf,
        test-cjson,
        test-domo-node-sdk,
        test-php-xml,
        test-swig,
        test-tcl,
        test-zstandard,
        test-functionbeat,
        test-cilium,
        test-eclipse_temurin,
        test-vvenc,
        test-elasticapmserver,
        test-dapr,
        test-openssh,
        test-gperftools,
        test-haystack
      ]
    runs-on: ubuntu-24.04-arm
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results
      
      - name: Create summary
        run: |
          echo "# üìä Package Test Summary (Batch 16)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TOTAL_PACKAGES=0
          PASSED_PACKAGES=0
          FAILED_PACKAGES=0
          
          for result_dir in test-results/*/; do
            if [ -d "$result_dir" ]; then
              TOTAL_PACKAGES=$((TOTAL_PACKAGES + 1))
              
              for json_file in "$result_dir"*.json; do
                if [ -f "$json_file" ]; then
                  PKG_NAME=$(jq -r '.package.name' "$json_file")
                  STATUS=$(jq -r '.run.status' "$json_file")
                  TESTS_PASSED=$(jq -r '.tests.passed' "$json_file")
                  TESTS_FAILED=$(jq -r '.tests.failed' "$json_file")
                  VERSION=$(jq -r '.package.version' "$json_file")
          VERSION=$(echo "$VERSION" | sed 's/[",]//g' | tr -d '\\' | sed 's/\x1b\[[0-9;]*m//g')
                  
                  if [ "$STATUS" = "success" ]; then
                    PASSED_PACKAGES=$((PASSED_PACKAGES + 1))
                    echo "‚úÖ **$PKG_NAME** (v$VERSION): $TESTS_PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                  else
                    FAILED_PACKAGES=$((FAILED_PACKAGES + 1))
                    echo "‚ùå **$PKG_NAME** (v$VERSION): $TESTS_FAILED tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
                fi
              done
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Summary (Batch 16)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Packages Tested:** $TOTAL_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** $PASSED_PACKAGES ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** $FAILED_PACKAGES ‚ùå" >> $GITHUB_STEP_SUMMARY

      - name: Trigger Global Summary (If Last Batch)
        if: always()
        uses: actions/github-script@v7
        env:
          GH_TOKEN: ${ secrets.GITHUB_TOKEN }
        with:
          script: |
            const headBranch = context.ref.replace('refs/heads/', '');
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const batchWorkflows = workflows.data.workflows.filter(w => 
              w.name.startsWith("Test All Packages (Batch") && 
              w.path.includes("test-all-packages-batch")
            );
            
            let totalActive = 0;
            for (const w of batchWorkflows) {
              if (w.name === context.workflow) continue;
              
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "in_progress"
              });
              const queued = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: w.id,
                branch: headBranch,
                status: "queued"
              });
              totalActive += runs.data.total_count + queued.data.total_count;
            }
            
            if (totalActive > 0) {
              console.log(`‚ö†Ô∏è Other batches are still active (${totalActive} runs). NOT triggering summary.`);
            } else {
              console.log(`‚úÖ No other batches active. Triggering global summary...`);
              await exec.exec(`gh workflow run test-all-packages-summary.yml --ref ${headBranch} --repo ${context.repo.owner}/${context.repo.repo}`);
            }

